# CallMe v2 - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Asterisk –∏ –ë–∏—Ç—Ä–∏–∫—Å24

–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞ [callme](https://github.com/Demosthen42/callme) —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π PHP 8.2+, –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è transfer'–æ–≤ –∏ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –ë–∏—Ç—Ä–∏–∫—Å24.

**–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç:** https://habrahabr.ru/post/349316/

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–æ—Ç–ª–∏—á–∏—è-–æ—Ç-–æ—Ä–∏–≥–∏–Ω–∞–ª–∞)
2. [–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#–Ω–æ–≤—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
3. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–∏–∑–º–µ–Ω–µ–Ω–∏—è)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
5. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
6. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
7. [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

---

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

### 1. **PHP 8.2+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
- ‚úÖ –ü–æ–ª–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ PHP 8.2.29
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ deprecated —Ñ—É–Ω–∫—Ü–∏–∏ PHP 5.3
- ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ PAMI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PHP 8.2
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

### 2. **–†–∞–±–æ—Ç–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ë–∏—Ç—Ä–∏–∫—Å24**
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ë–∏—Ç—Ä–∏–∫—Å24 (CentOS 9), –∞ –Ω–µ –Ω–∞ –ê–¢–°
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ê–¢–° —á–µ—Ä–µ–∑ AMI (Asterisk Manager Interface)
- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∏–∞–ª–ø–ª–∞–Ω–µ:** —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è `b24_continuous_parallel.conf`
- ‚úÖ –ú–æ–¥—É–ª—å –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –∏ –ø–µ—Ä–µ–¥–∞—á—É Linkedid
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å FreePBX –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —è–¥—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ include –≤ extensions_custom.conf)

### 3. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤**
- ‚úÖ –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ CallMeOut.php
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–±—Ö—É–∫–∞–º–∏ –ë–∏—Ç—Ä–∏–∫—Å24 (`ONEXTERNALCALLSTART`)
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ Originate-–≤—ã–∑–æ–≤–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–≤–æ–Ω–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ

### 4. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ Transfer –∑–≤–æ–Ω–∫–æ–≤**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –º–µ–∂–¥—É –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Linkedid –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–∞–Ω–∞–ª–æ–≤
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ BridgeEvent –∏ BRIDGEPEER
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ/–ø–æ–∫–∞–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ transfer

### 5. **–£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å CRM**
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –∑–≤–æ–Ω–æ–∫ –∏–∑ CRM (ASSIGNED_BY_ID)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π, –ø–æ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Contact/Company/Lead —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

---

## ‚ú® –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. **–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ Originate**

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ –Ω–æ–º–µ—Ä –≤ –ë–∏—Ç—Ä–∏–∫—Å24
2. –ë–∏—Ç—Ä–∏–∫—Å24 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫ `ONEXTERNALCALLSTART` –Ω–∞ `CallMeOut.php`
3. CallMeOut.php –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ AMI:
   - –°–Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–æ–∫ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, SIP/219)
   - –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ - –∏—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞
4. CallMeIn.php –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∑–≤–æ–Ω–∫–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ Linkedid
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–≤–æ–Ω–∫–∞ (200/304/486/603)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–ø–∏—Å–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤

### 2. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ Transfer –∑–≤–æ–Ω–∫–æ–≤**

**–î–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**

**A) –ß–µ—Ä–µ–∑ BridgeEvent (–æ—Å–Ω–æ–≤–Ω–æ–π):**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –º–æ–º–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –∫–∞–Ω–∞–ª–∞ –∫ –Ω–æ–≤–æ–º—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É —É —Å—Ç–∞—Ä–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –Ω–æ–≤–æ–º—É –∞–±–æ–Ω–µ–Ω—Ç—É
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é transfer'–æ–≤

**B) –ß–µ—Ä–µ–∑ BRIDGEPEER (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π):**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π BRIDGEPEER –≤ –∫–∞–Ω–∞–ª–∞—Ö
- –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç bridge –º–µ–∂–¥—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏ (–ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ transfer –≤–Ω–µ—à–Ω–µ–≥–æ –∑–≤–æ–Ω–∫–∞

**–ü—Ä–∞–≤–∏–ª–æ "–ö—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ—Ç –∏ –ø–∞–ø–∞":**
- –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–±–æ–Ω–µ–Ω—Ç –∏–∑ transfer
- –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ CDR –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É

### 3. **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∑–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–æ–≤**

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ú–æ–¥—É–ª—å `b24_continuous_parallel.conf` **–¢–†–ï–ë–£–ï–¢–°–Ø** —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ê–¢–° (Asterisk). –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–ø–ª–∞–Ω–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã CallMe.

**–ú–æ–¥—É–ª—å:** `contrib/b24_continuous_parallel.conf`

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∑–∞–ø–∏—Å–∏:**

–ó–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ **MixMonitor** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é Asterisk, –∏—Å–ø–æ–ª—å–∑—É—é—â—É—é **Audio Hook API** –¥–ª—è "–ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏—è" –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–æ–≤ –∫–∞–Ω–∞–ª–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

1. **Audio Hook API (–ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤):**
   - Asterisk –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º **Audio Hooks** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞–º –∫–∞–Ω–∞–ª–∞
   - MixMonitor "–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è" –∫ –∫–∞–Ω–∞–ª—É —á–µ—Ä–µ–∑ Audio Hook –∏ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–ø–∏—é –≤—Å–µ—Ö –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã—Ö
   - –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å)
   - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∑–≤–æ–Ω–∫–∏ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∏

2. **AUDIOHOOK_INHERIT - –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:**
   - –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ `AUDIOHOOK_INHERIT(MixMonitor)=yes` –∑–∞–ø–∏—Å—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è** –ø—Ä–∏ Transfer
   - –ö–æ–≥–¥–∞ –∑–≤–æ–Ω–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞, MixMonitor –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
   - –ù–æ–≤—ã–π –∫–∞–Ω–∞–ª –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ—Ç –∂–µ Audio Hook, –∑–∞–ø–∏—Å—å –∏–¥–µ—Ç –≤ **—Ç–æ—Ç –∂–µ —Ñ–∞–π–ª**
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: **–æ–¥–∏–Ω –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ñ–∞–π–ª** –≤–º–µ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã—Ö —á–∞—Å—Ç–µ–π

3. **Linkedid –∫–∞–∫ –∫–ª—é—á –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:**
   - –ò–º—è —Ñ–∞–π–ª–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ `linkedid` –∫–∞–Ω–∞–ª–∞
   - –í—Å–µ –∫–∞–Ω–∞–ª—ã –æ–¥–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `linkedid`
   - –ü—Ä–∏ Transfer –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ—Ç –∂–µ `linkedid` ‚Üí –∑–∞–ø–∏—Å—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø–∏—Å–∏:**

```
1. –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚Üí –∫–∞–Ω–∞–ª SIP/trunk-000026d8 (linkedid=ABC)
   ‚îî‚îÄ> MixMonitor –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è ‚Üí call-ABC.wav
   
2. Transfer –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 219 ‚Üí –∫–∞–Ω–∞–ª SIP/219-000026d9 (linkedid=ABC)
   ‚îî‚îÄ> MixMonitor –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ (linkedid —É–∂–µ –µ—Å—Ç—å)
   ‚îî‚îÄ> AUDIOHOOK_INHERIT=yes ‚Üí –∑–∞–ø–∏—Å—å –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è ‚Üí call-ABC.wav (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!)
   
3. Transfer –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 220 ‚Üí –∫–∞–Ω–∞–ª SIP/220-000026da (linkedid=ABC)
   ‚îî‚îÄ> MixMonitor –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ
   ‚îî‚îÄ> AUDIOHOOK_INHERIT=yes ‚Üí –∑–∞–ø–∏—Å—å –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è ‚Üí call-ABC.wav (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!)
   
4. –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
   ‚îî‚îÄ> MixMonitor –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   ‚îî‚îÄ> –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: lame ‚Üí call-ABC.mp3
   ‚îî‚îÄ> WAV —Ñ–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è
   
–†–µ–∑—É–ª—å—Ç–∞—Ç: call-ABC.mp3 —Å–æ–¥–µ—Ä–∂–∏—Ç –í–°–Æ –±–µ—Å–µ–¥—É –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞!
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**

- ‚úÖ **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å:** –æ–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ –≤–µ—Å—å –∑–≤–æ–Ω–æ–∫, –¥–∞–∂–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö transfer
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å:** –∑–∞–ø–∏—Å—å –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è WAV ‚Üí MP3 –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ø–µ—Ä–µ–¥–∞—á–∞ Linkedid –≤ CallMe —á–µ—Ä–µ–∑ AMI —Å–æ–±—ã—Ç–∏—è

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É `/var/spool/asterisk/continuous/`
- –û–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ –≤–µ—Å—å –∑–≤–æ–Ω–æ–∫ (–¥–∞–∂–µ –ø—Ä–∏ Transfer)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è WAV ‚Üí MP3 —á–µ—Ä–µ–∑ lame (bitrate 64 kbps)
- –ü–µ—Ä–µ–¥–∞—á–∞ Linkedid –≤ CallMe —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `CallMeLINKEDID` (AMI VarSetEvent)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏ (–Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
/var/spool/asterisk/continuous/2025/10/26/call-1761855304.108488.mp3
```
–û–¥–∏–Ω —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Å—å —Ä–∞–∑–≥–æ–≤–æ—Ä, –≤–∫–ª—é—á–∞—è –≤—Å–µ transfer –º–µ–∂–¥—É –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏.

### 4. **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å AMI —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ watchdog**

- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ —Å–æ–±—ã—Ç–∏—è–º AMI –∏ –±—ã—Å—Ç—Ä–æ–º—É —Ö—ç—à—É –∫–ª—é—á–µ–≤—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ (`calls`, `originateCalls`, `transferHistory`, `Onhold`).
- –ï—Å–ª–∏ 30 —Å–µ–∫—É–Ω–¥ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `PingAction`; —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä—ã, –∞ —Å–±–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π reconnect.
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ health-check –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø–∏–Ω–≥–∏.
- –õ–æ–≥–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ `logs/ami_healthcheck.log` —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ –∫–∞–Ω–∞–ª–∞–º `ping`, `watchdog`, `reconnect`.
- –¢–∞–π–º–∞—É—Ç —É–¥–µ—Ä–∂–∞–Ω–∏—è —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 60 —Å–µ–∫—É–Ω–¥ (–∫–æ–Ω—Ñ–∏–≥ `hold_timeout`), —á—Ç–æ–±—ã MusicOnHold –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤.

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –ê–¢–°:**

–ú–æ–¥—É–ª—å **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Asterisk:

```bash
# 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –Ω–∞ –ê–¢–°
sudo cp b24_continuous_parallel.conf /etc/asterisk/

# 2. –î–æ–±–∞–≤–∏—Ç—å –≤ extensions_custom.conf
echo "#include b24_continuous_parallel.conf" | sudo tee -a /etc/asterisk/extensions_custom.conf

# 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–ª–ø–ª–∞–Ω
sudo asterisk -rx "dialplan reload"

# 4. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –∑–∞–ø–∏—Å–µ–π
sudo mkdir -p /var/spool/asterisk/continuous
sudo chown -R asterisk:asterisk /var/spool/asterisk/continuous

# 5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å lame (–¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ MP3)
sudo yum install lame  # CentOS/RHEL
# –∏–ª–∏
sudo apt-get install lame  # Debian/Ubuntu
```

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏:**

```
–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (FreePBX):
/var/spool/asterisk/monitor/2025/10/26/
‚îú‚îÄ‚îÄ in-79991234567-201-20251026-153045-1730036445.123.wav  ‚Üê —á–∞—Å—Ç—å 1 (—Å–æ—Ç—Ä. 201)
‚îî‚îÄ‚îÄ in-79991234567-202-20251026-153145-1730036445.456.wav  ‚Üê —á–∞—Å—Ç—å 2 (—Å–æ—Ç—Ä. 202)
‚ùå –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞, —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä

–ù–æ–≤—ã–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (CallMe):
/var/spool/asterisk/continuous/2025/10/26/
‚îî‚îÄ‚îÄ call-1730036445.123456.mp3  ‚Üê –ü–û–õ–ù–ê–Ø –∑–∞–ø–∏—Å—å (201+202 –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ!)
‚úÖ –û–¥–∏–Ω —Ñ–∞–π–ª, –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä
```

### 4. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–†–µ–∂–∏–º DEBUG (`CallMeDEBUG = true`):**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –ë–∏—Ç—Ä–∏–∫—Å24 (URL + –ø–∞—Ä–∞–º–µ—Ç—Ä—ã JSON)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç API
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π AMI
- –ü–æ–ª–Ω—ã–π –ª–æ–≥ —Å–æ–±—ã—Ç–∏–π –≤ `full.log` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
Bitrix24 API Request
[URL] => https://example.com/rest/<user_id>/xxx/telephony.externalcall.register.json
[METHOD] => telephony.externalcall.register
[PARAMS] => Array(...)
[PARAMS_JSON] => {
    "USER_ID": <user_id>,
    "PHONE_NUMBER": "74951234567",
    ...
}
```

### 5. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ**

**–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª):**
1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º (100)
2. –ü–æ–ø—ã—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (—É–∂–µ –ø–æ–∑–¥–Ω–æ!)

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
1. –ü–æ–∏—Å–∫ CRM-—Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (ASSIGNED_BY_ID)
3. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –Ω–æ–º–µ—Ä–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º

**–ú–µ—Ç–æ–¥—ã:**
- `getCrmEntityDataByPhone()` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è + ID –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
- `getResponsibleIntNum()` - –ø–æ–ª—É—á–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–∞ `responsible_mode` (crm_responsible / static_mapping)

### 6. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π DialBegin/DialEnd**

**–ü—Ä–æ–±–ª–µ–º–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:**
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ DialBegin/DialEnd –ø—ã—Ç–∞–ª–∏—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å Originate-–≤—ã–∑–æ–≤—ã
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–æ—á–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –≤ –ë24 (–ø–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ DialString)

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ Originate-–≤—ã–∑–æ–≤–æ–≤ –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ DialBegin/DialEnd
- Originate-–≤—ã–∑–æ–≤—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `$globalsObj->originateCalls`

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. **–ê–¥–∞–ø—Ç–∞—Ü–∏—è PAMI –¥–ª—è PHP 8.2**

**–ü—Ä–æ–±–ª–µ–º—ã –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:**
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `marcelog/pami` —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è PHP 5.3
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ deprecated —Ñ—É–Ω–∫—Ü–∏–π
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–æ –≤–µ—Ä—Å–∏–∏ 2.* (—á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–π —Å PHP 8.2)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã `array_key_exists()` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ç–∏–ø–∞ –º–∞—Å—Å–∏–≤–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º

### 2. **–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Originate**

```php
$globalsObj->originateCalls[$linkedid] = [
    'channels' => [],           // –í—Å–µ –∫–∞–Ω–∞–ª—ã –≤—ã–∑–æ–≤–∞
    'call_id' => null,          // CALL_ID –æ—Ç –ë–∏—Ç—Ä–∏–∫—Å24
    'intNum' => null,           // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä
    'is_originate' => true,     // –ú–∞—Ä–∫–µ—Ä Originate
    'answered' => false,        // –§–ª–∞–≥ –æ—Ç–≤–µ—Ç–∞
    'answer_time' => null,      // –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
    'last_dialstatus' => null,  // –ü–æ—Å–ª–µ–¥–Ω–∏–π DialStatus
    'last_hangup_cause' => null,// –ü–æ—Å–ª–µ–¥–Ω–∏–π HangupCause
    'record_url' => null,       // URL –∑–∞–ø–∏—Å–∏
    'created_at' => time(),     // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
    'last_activity' => time()   // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
];
```

### 3. **–ò—Å—Ç–æ—Ä–∏—è Transfer'–æ–≤**

```php
$globalsObj->transferHistory[$externalUniqueid] = [
    'externalChannel' => 'SIP/trunk-000026d8',
    'externalUniqueid' => '1761855304.108488',
    'call_id' => 'externalCall.xxx',
    'currentIntNum' => 220,  // –¢–µ–∫—É—â–∏–π –∞–±–æ–Ω–µ–Ω—Ç
    'history' => [
        ['from' => 219, 'to' => 220, 'timestamp' => 1730036445]
    ]
];
```

### 4. **–ú–∞–ø–ø–∏–Ω–≥ Uniqueid ‚Üí Linkedid**

```php
$globalsObj->uniqueidToLinkedid[$uniqueid] = $linkedid;
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ –∫–∞–Ω–∞–ª–æ–≤ Originate —Å –æ—Å–Ω–æ–≤–Ω—ã–º Linkedid.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ë–∏—Ç—Ä–∏–∫—Å24 –°–µ—Ä–≤–µ—Ä                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ         CallMe Application                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ CallMeIn.php ‚îÇ      ‚îÇ CallMeOut.php‚îÇ         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ (AMI Listener)‚îÇ     ‚îÇ (Webhook)    ‚îÇ         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ                      ‚îÇ                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ AMI Events           ‚îÇ Webhook        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ            ‚îÇ                      ‚îÇ                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                      ‚îÇ
             ‚îÇ TCP 5038             ‚îÇ HTTP/HTTPS
             ‚îÇ                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Asterisk PBX                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  AMI (Asterisk Manager Interface)                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - NewchannelEvent                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - DialBegin/DialEnd                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - BridgeEvent                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - VarSetEvent (CallMeLINKEDID, CallMeCALL_ID)   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - HangupEvent                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Dialplan Hook                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  b24_continuous_parallel.conf                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç CallMeLINKEDID                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å                 ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

**–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫:**
```
1. –í–Ω–µ—à–Ω–∏–π –∫–ª–∏–µ–Ω—Ç ‚Üí Asterisk (SIP)
2. Asterisk ‚Üí AMI Event (NewchannelEvent)
3. CallMeIn.php ‚Üí API –ë24 (crm.duplicate.findbycomm)
4. API –ë24 ‚Üí CallMeIn.php (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)
5. CallMeIn.php ‚Üí API –ë24 (telephony.externalcall.register)
6. API –ë24 ‚Üí CallMeIn.php (call_id)
7. CallMeIn.php ‚Üí API –ë24 (telephony.externalcall.showCard)
8. –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è ‚Üí CallMeIn.php ‚Üí API –ë24 (telephony.externalcall.finish)
```

**–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë24 ‚Üí –ö–ª–∏–∫ –Ω–∞ –Ω–æ–º–µ—Ä
2. –ë24 ‚Üí CallMeOut.php (–≤–µ–±—Ö—É–∫ ONEXTERNALCALLSTART)
3. CallMeOut.php ‚Üí AMI (Originate: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ‚Üí –≤–Ω–µ—à–Ω–∏–π)
4. Asterisk ‚Üí AMI Events (VarSet: IS_CALLME_ORIGINATE, CallMeCALL_ID)
5. CallMeIn.php ‚Üí –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
6. CallMeIn.php ‚Üí API –ë24 (telephony.externalcall.showCard)
7. –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è ‚Üí CallMeIn.php ‚Üí API –ë24 (telephony.externalcall.finish)
```

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- PHP 8.2.29 –∏–ª–∏ –≤—ã—à–µ
- CentOS 9 (–∏–ª–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π Linux)
- Asterisk 1.8.13+ —Å AMI
- –î–æ—Å—Ç—É–ø –∫ API –ë–∏—Ç—Ä–∏–∫—Å24 (REST API)
- Composer

### –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd /var/www/
git clone https://github.com/your-repo/callme.git callme
cd callme

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
composer install --no-dev

# 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp config.example.php config.php
nano config.php  # –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

# 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
chown -R www-data:www-data /var/www/callme
chmod +x CallMeIn.php CallMeOut.php

# 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–µ–ø–ª–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
cd deploy/
sudo ./install.sh
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ Asterisk:

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –º–æ–¥—É–ª—å **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ê–¢–° (Asterisk). –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–ø–ª–∞–Ω–µ Asterisk, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã CallMe.

```bash
# 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –Ω–∞ –ê–¢–°
sudo cp contrib/b24_continuous_parallel.conf /etc/asterisk/

# 2. –î–æ–±–∞–≤–∏—Ç—å –≤ extensions_custom.conf (–ù–ï —É–¥–∞–ª—è—Ç—å!)
echo "#include b24_continuous_parallel.conf" | sudo tee -a /etc/asterisk/extensions_custom.conf

# 3. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –∑–∞–ø–∏—Å–µ–π
sudo mkdir -p /var/spool/asterisk/continuous
sudo chown -R asterisk:asterisk /var/spool/asterisk/continuous

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å lame (–¥–ª—è –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ WAV ‚Üí MP3)
sudo yum install lame  # CentOS/RHEL
# –∏–ª–∏
sudo apt-get install lame  # Debian/Ubuntu

# 5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–ª–ø–ª–∞–Ω
sudo asterisk -rx "dialplan reload"

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞
sudo asterisk -rx "dialplan show sub-record-check-custom"
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–æ–¥—É–ª—å:**

1. **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `CallMeLINKEDID`** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ ‚Üí CallMe –ø–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ AMI VarSetEvent
2. **–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π MixMonitor** –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏
3. **–ù–∞—Å–ª–µ–¥—É–µ—Ç –∑–∞–ø–∏—Å—å –ø—Ä–∏ Transfer** —á–µ—Ä–µ–∑ `AUDIOHOOK_INHERIT=yes`
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç** WAV ‚Üí MP3 –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
5. **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `CallMeFULLFNAME`** —Å –ø—É—Ç–µ–º –∫ –∑–∞–ø–∏—Å–∏ ‚Üí CallMe –ø–æ–ª—É—á–∞–µ—Ç URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ë–∏—Ç—Ä–∏–∫—Å24

**–ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:**

- –ë–µ–∑ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è CallMe –Ω–µ —Å–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å `Linkedid` –∫–∞–Ω–∞–ª–æ–≤
- –ë–µ–∑ `Linkedid` –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å transfer'—ã –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–≤–æ–Ω–∫–∏
- –ë–µ–∑ –º–æ–¥—É–ª—è –Ω–µ –±—É–¥–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (—Ç–æ–ª—å–∫–æ —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–∏ transfer)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ supervisord:

```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo cp deploy/supervisord.conf /etc/supervisord.d/callme.ini

# –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—É—Ç–∏
sudo nano /etc/supervisord.d/callme.ini

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ supervisord
sudo systemctl restart supervisord
sudo supervisorctl reread
sudo supervisorctl add callme
sudo supervisorctl start callme
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `config.php`:

```php
return array(
    // Asterisk AMI
    'asterisk' => array(
        'host' => '192.168.1.100',  // IP –ê–¢–°
        'scheme' => 'tcp://',
        'port' => 5038,
        'username' => 'b24',
        'secret' => 'your_secret',
        'connect_timeout' => 10,    // —Å–µ–∫: –æ–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ TCP
        'read_timeout' => 10000,    // –º—Å: –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (‚âà10 —Å–µ–∫)
    ),
    
    // Bitrix24 API
    'bitrixApiUrl' => 'https://your-domain.bitrix24.ru/rest/1/webhook/',
    'authToken' => 'your-token',
    
    // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    'tech' => 'SIP',
    'context' => 'from-internal',
    
    // –í–Ω–µ—à–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    'extentions' => array('8001231231', '8002345678'),
    
    // –†–µ–∂–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
    'responsible_mode' => 'crm_responsible',  // –∏–ª–∏ 'static_mapping'
    
    // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ (fallback)
    'bx24' => array(
        '8001' => '101',
        'default_user_number' => '100',
    ),
    
    // –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    'user_show_cards' => array('101', '102', '103'),
    
    // –ü–∞—É–∑–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (–º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã)
    'listener_timeout' => 50000,

    // Health-check AMI
    'healthCheckTimeout' => 5,   // —Å–µ–∫: —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Ü–∏–∫–ª–∞—Ö
    'pingIdleTimeout' => 30,     // —Å–µ–∫: –ø–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ "–∑–∞—Å–Ω—É–≤—à–∏—Ö" –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
    'hold_timeout' => 60,        // —Å–µ–∫: –º–∞–∫—Å–∏–º—É–º —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ Hangup

    'ami_healthcheck_log' => array(
        'ping' => array('NOTICE' => true, 'DEBUG' => false),
        'watchdog' => array('NOTICE' => true, 'DEBUG' => false),
        'reconnect' => array('NOTICE' => true, 'DEBUG' => false),
    ),

    // Debug —Ä–µ–∂–∏–º
    'CallMeDEBUG' => true,
    'enable_full_log' => false,
);
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ –ë–∏—Ç—Ä–∏–∫—Å24:

1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –¢–µ–ª–µ—Ñ–æ–Ω–∏—è ‚Üí –í–µ–±—Ö—É–∫–∏
2. –î–æ–±–∞–≤—å—Ç–µ –≤–µ–±—Ö—É–∫ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤:
   - URL: `http://your-server/callme/CallMeOut.php`
   - –°–æ–±—ã—Ç–∏—è: `ONEXTERNALCALLSTART`
   - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —Ç–æ–∫–µ–Ω –∏–∑ `config.php`

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ CallMeIn.php:

```bash
# –ß–µ—Ä–µ–∑ supervisord (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
sudo supervisorctl start callme

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
php /var/www/callme/CallMeIn.php &

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
tail -f /var/www/callme/logs/CallMe.log
```

### Health-check AMI –∏ watchdog

- –ö–∞–∂–¥–æ–º—É —Å–æ–±—ã—Ç–∏—é AMI —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–º–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ (`calls`, `originateCalls`, `transferHistory`, `Onhold`) —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ö–µ—à.
- –ï—Å–ª–∏ 30 —Å–µ–∫—É–Ω–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ AMI –∏ —Ö–µ—à –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `PingAction`; —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä—ã, –ø—Ä–æ–≤–∞–ª –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é.
- –ü—Ä–∏ –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–∞—Ö health-check –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø–∏–Ω–≥–∏ –≤ –º–æ–º–µ–Ω—Ç—ã –ø—Ä–æ—Å—Ç–æ—è.
- –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –ª–æ–≥ `logs/ami_healthcheck.log` —Å –∫–∞–Ω–∞–ª–∞–º–∏ `ping`, `watchdog`, `reconnect` (—É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `ami_healthcheck_log`).
- –¢–∞–π–º–∞—É—Ç —É–¥–µ—Ä–∂–∞–Ω–∏—è —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 60 —Å–µ–∫—É–Ω–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `hold_timeout`), —á—Ç–æ–±—ã —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–∞ MusicOnHold –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AMI
sudo asterisk -rx "manager show connected"

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ –ª–æ–≥–∞—Ö
tail -f /var/www/callme/logs/CallMe.log | grep "ORIGINATE\|TRANSFER"

# 3. –¢–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
# –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞ –æ–¥–∏–Ω –∏–∑ –Ω–æ–º–µ—Ä–æ–≤ –∏–∑ 'extentions'

# 4. –¢–µ—Å—Ç–æ–≤—ã–π –∏—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
# –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä –≤ –ë–∏—Ç—Ä–∏–∫—Å24
```

---

## üìù –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

| –§—É–Ω–∫—Ü–∏—è | –û—Ä–∏–≥–∏–Ω–∞–ª | CallMe v2 |
|---------|----------|-----------|
| **PHP –≤–µ—Ä—Å–∏—è** | 5.3 | 8.2+ |
| **–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏** | –ù–∞ –ê–¢–° | –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ë24 |
| **–ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–∏–∞–ª–ø–ª–∞–Ω–∞** | –¢—Ä–µ–±—É—é—Ç—Å—è | –ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è |
| **–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏** | ‚ùå –ù–µ—Ç | ‚úÖ –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| **Transfer –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ** | ‚ùå –ù–µ—Ç | ‚úÖ –ß–µ—Ä–µ–∑ Linkedid |
| **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ** | –î–µ—Ñ–æ–ª—Ç–Ω—ã–π | –ò–∑ CRM |
| **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∑–∞–ø–∏—Å—å** | ‚ùå –ù–µ—Ç | ‚úÖ –ú–æ–¥—É–ª—å –∑–∞–ø–∏—Å–∏ |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ë–∞–∑–æ–≤–æ–µ | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ (DEBUG) |

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

1. ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ transfer (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ bridge –º–µ–∂–¥—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏)
2. ‚úÖ –ü–æ—Ç–µ—Ä—è CALL_ID –ø—Ä–∏ Originate-–≤—ã–∑–æ–≤–∞—Ö (–æ–±—Ä–∞–±–æ—Ç–∫–∞ CallMeCALL_ID –¥–æ CallMeLINKEDID)
3. ‚úÖ –û—à–∏–±–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã user.get —Å DialString (–∏—Å–∫–ª—é—á–µ–Ω–∏–µ Originate –∏–∑ DialBegin/DialEnd)
4. ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–æ–º–µ—Ä (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
5. ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Originate-–≤—ã–∑–æ–≤–æ–≤ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DialStatus/HangupCause)

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é](deploy/README.md)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ –∑–≤–æ–Ω–∫–æ–≤](contrib/b24_continuous_parallel.conf)
- [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π](contrib/)

---

## üë• –ê–≤—Ç–æ—Ä—ã

- **–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç:** [ViStep.RU](https://github.com/ViStepRU/callme)
- **–§–æ—Ä–∫ –±–µ–∑ –¥–∏–∞–ª–ø–ª–∞–Ω–∞:** [Demosthen42/callme](https://github.com/Demosthen42/callme)
- **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è PHP 8.2:** Anton-Sevnet

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–°–º. –ª–∏—Ü–µ–Ω–∑–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.

---

## üîó –°—Å—ã–ª–∫–∏

- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è: https://habrahabr.ru/post/349316/
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ PAMI: https://github.com/marcelog/PAMI
- Asterisk AMI: https://wiki.asterisk.org/wiki/display/AST/The+Asterisk+Manager+Interface

---

**–í–µ—Ä—Å–∏—è:** 2.1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-07
