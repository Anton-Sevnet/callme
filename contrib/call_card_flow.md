# Механизм показа карточек звонка в Bitrix24

## Быстрая схема

- **Хранилище состояния.** Все активные звонки ведутся через синглтон `Globals`. В нём хранятся:
  - соответствия `linkedid → CALL_ID`;
  - текущие звонящие внутренние номера (`ringingIntNums`);
  - список пользователей, у которых уже показана карточка (`callShownCards`);
  - история трансферов (`transferHistory`);
  - отложенные регистрации (`pendingCalls`, `pendingCallsByCaller`).
- **Нормализация и поиск CRM.** На `Newchannel` из AMI номер абонента нормализуется, в CRM ищется сущность и ответственный. CallerID в АТС обновляется именем из CRM.
- **Отложенная регистрация.** Пока нет подходящего агента, данные складируются в `pendingCalls`. Это позволяет зарегистрировать звонок в Bitrix24 именно на того сотрудника, у кого реально звонит телефон.

## Регистрация и получение CALL_ID

1. При первом `DialBegin` для внутреннего канала (прямой вызов, очередь, ring-group) из `pendingCalls` выбирается кандидат.
2. Через `HelperFuncs::runInputCall` выполняется REST `telephony.externalcall.register`.
3. Ответ `CALL_ID` сохраняется в `Globals::$callIdByLinkedid` и `Globals::$calls`.
4. В `ringingIntNums` фиксируется состояние `RING` для текущего внутреннего номера, а `ringOrder` отслеживает порядок дозвонов.

## Показ карточек

- Функция `callme_show_cards_for_ringing` собирает всех внутренних с состоянием `RING`, у которых карточка ещё не показана.
- Один REST-запрос `telephony.externalcall.show` отправляется списком `USERS`, после чего для каждого абонента проставляется флаг `shown`.
- Дополнительно доступны точечные вызовы через `HelperFuncs::showInputCall()` (один пользователь) или `showInputCallForUsers()` (bulk).

## Реакция на события AMI

### DialEnd (ANSWER/BUSY/CANCEL)

- При `ANSWER`:
  - карточки скрываются у всех остальных (`telephony.externalcall.hide` через `hideInputCallList`);
  - звонящий остаётся помеченным как принявший;
  - фиксируется внутренний номер в `callCrmData`.
- При `BUSY` или `CANCEL`:
  - карточка скрывается у данного сотрудника;
  - запись удаляется из `ringingIntNums`, чтобы при повторном дозвоне карточка могла показаться снова.

### Bridge/BRIDGEPEER (трансферы)

- `BridgeEvent` со статусом `Link` и `VarSetEvent` по переменной `BRIDGEPEER` отслеживают перевод звонка на другого внутреннего.
- Старому оператору карточка скрывается, новому — показывается (`showInputCall`).
- История перемещений фиксируется в `transferHistory`.

### Hangup

- На `HangupEvent` вызывается `telephony.externalcall.finish` с итоговым статусом и длительностью.
- Карточки скрываются у всех участников (`hideInputCallList` + точечный `hideInputCall`).
- Очищаются массивы `pendingCalls`, `callShownCards`, `ringingIntNums`, `transferHistory`, `uniqueidToLinkedid` и т.д.

## Особые случаи

- **Очереди / ring-group.** Каждый новый `DialBegin` добавляет абонента в `ringingIntNums`; карточка всплывает всем, где `state='RING'`. Если АТС перестаёт звонить абоненту, карточка скрывается автоматически по `DialEnd`.
- **Нет ответственного.** Скрипт ждёт первого реального агента. При полном отсутствии задействуется `fallback_responsible_user_id`.
- **user_show_cards.** Если в конфиге задан список, всплытие ограничивается указанными внутренними номерами.
- **Исходящие (Originate).** Для исходящих используется отдельный блок в `CallMeIn.php`, но показ/скрытие карточек реализован теми же REST-хелперами (`telephony.externalcall.show/hide`).

## Ключевые REST-вызовы Bitrix24

| Метод REST                         | Где используется                           | Назначение                                         |
|-----------------------------------|--------------------------------------------|----------------------------------------------------|
| `telephony.externalcall.register` | `HelperFuncs::runInputCall`                | Регистрация входящего звонка, получение `CALL_ID`. |
| `telephony.externalcall.show`     | `showInputCall`, `showInputCallForUsers`   | Показ карточки сотруднику или списку сотрудников.  |
| `telephony.externalcall.hide`     | `hideInputCall`, `hideInputCallList`       | Скрытие карточки у конкретного сотрудника.         |
| `telephony.externalcall.finish`   | `HelperFuncs::finishCall`                  | Завершение звонка, запись длительности и статуса.  |

## Проверка конфигурации

- Убедитесь, что в `config.php` правильно заполнены:
  - `bitrixApiUrl` (вебхук с доступом к `telephony.*`);
  - `extentions` / `user_show_cards` (список внутренних номеров);
  - `fallback_responsible_user_id`.
- Для отладки включите `CallMeDEBUG`, чтобы видеть REST-запросы и ответы в `logs/CallMe.log`.

## Что тестировать после изменений

1. Входящий на прямой внутренний: карточка появляется у одного пользователя, скрывается после ответа и завершения.
2. Входящий на очередь/ring-group: карточки всплывают всем, переключаются при ответах и скрываются при снятии.
3. Трансфер между сотрудниками: карточка «переезжает» вместе с каналом.
4. Сценарий без ответственного в CRM: звонок регистрируется на первого реально звонящего или на fallback.

