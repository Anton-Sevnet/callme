;================================================================================
; CallMe v2 Integration for FreePBX
; Интеграция с Bitrix24 через AMI события
; Версия: 2.0 - только реальные SIP-каналы, без обработки Local-каналов
;================================================================================

;================================================================================
; 1. ПОДДЕРЖКА ЗАПИСИ ЗВОНКОВ (наследуется от FreePBX)
;================================================================================

[sub-record-check]
exten => record,1,Gosub(sub-record-check-custom,s,1)
exten => record,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => record,n,MixMonitor(${MIXMON_DIR}${YEAR}/${MONTH}/${DAY}/${CALLFILENAME}.${MON_FMT},,${MIXMON_POST})
exten => record,n,Set(__REC_STATUS=RECORDING)
exten => record,n,Set(CDR(recordingfile)=${CALLFILENAME}.${MON_FMT})
exten => record,n,Return()

exten => recq,1,Gosub(sub-record-check-custom,s,1)
exten => recq,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => recq,n,Set(MONITOR_FILENAME=${MIXMON_DIR}${YEAR}/${MONTH}/${DAY}/${CALLFILENAME})
exten => recq,n,MixMonitor(${MONITOR_FILENAME}.${MON_FMT},${MONITOR_OPTIONS}${MIXMON_BEEP},${MIXMON_POST})
exten => recq,n,Set(__REC_STATUS=RECORDING)
exten => recq,n,Set(CDR(recordingfile)=${CALLFILENAME}.${MON_FMT})
exten => recq,n,Return()

;================================================================================
; 2. ОСНОВНОЙ МАКРОС ДОЗВОНА (macro-dial-one)
; Интеграция CallMe происходит через macro-dial-one-custom
;================================================================================

[macro-dial-one]
include => macro-dial-one-custom
exten => s,1,Set(DEXTEN=${ARG3})
; Сохраняем CALLME_LINKEDID для отслеживания трансферов
exten => s,n,Set(__CALLME_LINKEDID=${IF($["${CALLME_LINKEDID}"=""]?${CHANNEL(linkedid)}:${CALLME_LINKEDID})})
; Сохраняем CALLME_CALL_ID если он уже установлен
exten => s,n,Set(__CALLME_CALL_ID=${CALLME_CALL_ID})
exten => s,n,Set(DIALSTATUS_CW=)
; Вызываем наш custom-хук ПЕРЕД основной логикой FreePBX
exten => s,n,GosubIf($["${DEXTEN}"!=""]?macro-dial-one-custom,s,1(${DEXTEN}))
; Стандартная логика FreePBX (screen, call forward, DND и т.д.)
exten => s,n,GosubIf($["${FROM_DID}"!="" & "${SCREEN}"="" & "${DB(AMPUSER/${DEXTEN}/screen)}"!=""]?screen,1())
exten => s,n,GosubIf($["${DB(CF/${DEXTEN})}"!=""]?cf,1())
exten => s,n,GotoIf($["${DEXTEN:-1}"="#" | "${DB(DND/${DEXTEN})}"=""]?skip1)
exten => s,n,Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=BUSY)
exten => s,n(skip1),GotoIf($["${DEXTEN}"=""]?nodial)
exten => s,n,GotoIf($["${DEXTEN:-1}"="#"]?continue)
exten => s,n,Set(EXTHASCW=${IF($["${CWIGNORE}"!=""]?"":${DB(CW/${DEXTEN})})})
exten => s,n,GotoIf($["${EXTHASCW}"="" | "${DB(CFB/${DEXTEN})}"!="" | "${DB(CFU/${DEXTEN})}"!=""]?next1:cwinusebusy)
exten => s,n(next1),GotoIf($["${DB(CFU/${DEXTEN})}"!="" & ("${EXTENSION_STATE(${DEXTEN})}"="UNAVAILABLE" | "${EXTENSION_STATE(${DEXTEN})}"="UNKNOWN")]?docfu:skip3)
exten => s,n(docfu),Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=NOANSWER)
exten => s,n,Goto(nodial)
exten => s,n(skip3),GotoIf($["${EXTHASCW}"="" | "${DB(CFB/${DEXTEN})}"!=""]?next2:continue)
exten => s,n(next2),GotoIf($["${EXTENSION_STATE(${DEXTEN})}"="NOT_INUSE" | "${EXTENSION_STATE(${DEXTEN})}"="UNAVAILABLE" | "${EXTENSION_STATE(${DEXTEN})}"="UNKNOWN"]?continue)
exten => s,n,ExecIf($["${DB(CFB/${DEXTEN})}"!="" & "${CFIGNORE}"=""]?Set(DIALSTATUS=BUSY))
exten => s,n,GotoIf($["${EXTHASCW}"!="" | "${DEXTEN:-1}"="#"]?cwinusebusy)
exten => s,n,Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=BUSY)
exten => s,n,Goto(nodial)
exten => s,n(cwinusebusy),GotoIf($["${EXTHASCW}"!="" & "${CWINUSEBUSY}"="true"]?next3:continue)
exten => s,n(next3),ExecIf($["${EXTENSION_STATE(${DEXTEN})}"!="UNAVAILABLE" & "${EXTENSION_STATE(${DEXTEN})}"!="NOT_INUSE" & "${EXTENSION_STATE(${DEXTEN})}"!="UNKNOWN"]?Set(DIALSTATUS_CW=BUSY))
exten => s,n(continue),GotoIf($["${DEXTEN}"=""]?nodial)
exten => s,n,GosubIf($["${DEXTEN:-1}"!="#"]?dstring,1():dlocal,1())
exten => s,n,GotoIf($[${LEN(${DSTRING})}=0]?nodial)
exten => s,n,GotoIf($["${DEXTEN:-1}"="#"]?skiptrace)
exten => s,n(skiptrace),Set(D_OPTIONS=${ARG2})
exten => s,n,ExecIf($["${NODEST}"!="" & "${CALLME_HAS_M}"!="1"]?Set(D_OPTIONS=${D_OPTIONS}M(auto-blkvm)))
exten => s,n,ExecIf($["${NODEST}"!="" & "${CALLME_HAS_M}"!="1"]?Set(CALLME_HAS_M=1))
exten => s,n,ExecIf($["${ALERT_INFO}"!=""]?SIPAddHeader(Alert-Info: ${ALERT_INFO}))
exten => s,n,ExecIf($["${SIPADDHEADER}"!=""]?SIPAddHeader(${SIPADDHEADER}))
exten => s,n,Gosub(sub-callme-opts,s,1)
exten => s,n,ExecIf($["${MOHCLASS}"!=""]?Set(CHANNEL(musicclass)=${MOHCLASS}))
exten => s,n,GosubIf($["${QUEUEWAIT}"!=""]?qwait,1())
exten => s,n,Set(__CWIGNORE=${CWIGNORE})
exten => s,n,Set(__KEEPCID=TRUE)
exten => s,n,GotoIf($["${USEGOTO}"="1"]?usegoto,1)
exten => s,n,GotoIf($["${DB(AMPUSER/${EXTTOCALL}/cidname)}" = "" | "${DB(AMPUSER/${AMPUSER}/cidname)}" = ""]?godial)
exten => s,n,Set(CONNECTEDLINE(name,i)=${DB(AMPUSER/${EXTTOCALL}/cidname)})
exten => s,n,Set(CONNECTEDLINE(num)=${EXTTOCALL})
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}I)
exten => s,n(godial),NoOp()
; Выполняем Dial с hooks для реальных SIP-каналов
; Примечание: CALLME_CARD_STATE=RING устанавливается через NewstateEvent в CallMeIn.php
; Опция g вызывает макрос на созданном канале при ANSWER
; Опция h вызывает макрос на созданном канале при HANGUP
exten => s,n,Dial(${DSTRING},${ARG1},${D_OPTIONS})
; После Dial: скрываем карточку у неответивших (если был RING, но не ANSWER)
exten => s,n,ExecIf($["${DIALSTATUS_CW}"!=""]?Set(DIALSTATUS=${DIALSTATUS_CW}))
exten => s,n,GosubIf($[("${SCREEN}"!=""&( "${DIALSTATUS}"="TORTURE"|"${DIALSTATUS}"="DONTCALL"))|"${DIALSTATUS}"="ANSWER"]?s-${DIALSTATUS},1())
exten => s,n,MacroExit()
exten => s,n(nodial),ExecIf($["${DIALSTATUS}" = ""]?Set(DIALSTATUS=NOANSWER))
exten => s,n,Noop(Returned from dial-one with nothing to call and DIALSTATUS: ${DIALSTATUS})
exten => s,n,MacroExit()

; Hangup extension - вызываем стандартный hangupcall
exten => h,1,Macro(hangupcall,)

exten => usegoto,1,Set(USEGOTO=)
exten => usegoto,n,Goto(from-internal,${DSTRING},1)

;================================================================================
; 3. CALLME HOOK: ПОДГОТОВКА ПЕРЕД DIAL
; Вызывается ПЕРЕД Dial() для настройки hooks на реальных SIP-каналах
;================================================================================

[macro-dial-one-custom]
exten => s,1,Noop(CallMe: Preparing dial hook for real SIP channels)
; Сохраняем linkedid для отслеживания трансферов
exten => s,n,Set(__CALLME_LINKEDID=${IF($["${CALLME_LINKEDID}"=""]?${CHANNEL(linkedid)}:${CALLME_LINKEDID})})
; Сохраняем CALL_ID если он уже установлен
exten => s,n,Set(__CALLME_CALL_ID=${CALLME_CALL_ID})
; Если CALL_ID не установлен - используем linkedid как временный идентификатор
exten => s,n,ExecIf($["${CALLME_CALL_ID}"=""]?Set(__CALLME_CALL_ID=${CHANNEL(linkedid)}))
; Подготовка ConnectedLine для подстановки имени клиента
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${CALLME_INGRESS_CHANNEL})}]?${CALLME_INGRESS_CHANNEL}:${CHANNEL(name)})})
; Получаем имя из SHARED переменной (устанавливается в NewChannelEvent)
exten => s,n,ExecIf($[${LEN(${CALLME_CONNECTEDLINE_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CONNECTEDLINE_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
exten => s,n,Noop(CallMe: ConnectedLine name='${CALLME_CONNECTEDLINE_NAME}' source='${CALLME_CL_SOURCE}')
; Сбрасываем флаг добавленных опций, чтобы sub-callme-opts выполнился после Set(D_OPTIONS=${ARG2})
exten => s,n,Set(__CALLME_HAS_CM_OPTS=)
exten => s,n,Return()

;================================================================================
; 4. CALLME HOOK: ДОБАВЛЕНИЕ DIAL OPTIONS ПОСЛЕ СТАНДАРТНОЙ ЛОГИКИ FREEPBX
;================================================================================

[sub-callme-opts]
exten => s,1,Noop(CallMe: Injecting dial options for real SIP channels)
exten => s,n,GotoIf($["${CALLME_HAS_CM_OPTS}"="1"]?done)
; Готовим данные для ConnectedLine, если их ещё нет
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${CALLME_INGRESS_CHANNEL})}]?${CALLME_INGRESS_CHANNEL}:${CHANNEL(name)})})
exten => s,n,ExecIf($[${LEN(${CALLME_CONNECTEDLINE_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CONNECTEDLINE_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
; Подмешиваем CallMe-опции к текущему D_OPTIONS
; Примечание: CALLME_CARD_STATE=RING устанавливается через NewstateEvent в CallMeIn.php
; когда опции Dial b()/B() не работают (например, в очередях через Local-каналы)
; g() - вызывается на реальном SIP-канале при ANSWER
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}g(sub-callme-answer^s^1))
; h() - вызывается на реальном SIP-канале при HANGUP
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}h(sub-callme-hangup^s^1))
exten => s,n,Set(__CALLME_HAS_CM_OPTS=1)
exten => s,n(done),Return()

;================================================================================
; 5. HOOK: ОБРАБОТКА RING на реальном SIP-канале
; Примечание: Этот контекст больше не используется напрямую через Dial опции
; CALLME_CARD_STATE=RING устанавливается через NewstateEvent в CallMeIn.php
; Оставлен для совместимости и возможного использования в будущем
;================================================================================

[sub-callme-ring]
exten => s,1,Noop(CallMe: Ring hook triggered on real SIP channel ${CHANNEL(name)})
; Извлекаем внутренний номер из имени реального SIP-канала (например, SIP/219-00000837 -> 219)
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CHANNEL(name),/,2)})
; Очищаем от суффиксов (-00000837, ;1 и т.д.)
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
; Оставляем только цифры
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})}))
; Проверяем что это валидный внутренний номер (2-6 цифр)
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved)
; Если не нашли - пробуем из CONNECTEDLINE
exten => s,n,Set(CALLME_EXT_RAW=${CONNECTEDLINE(num)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved:return)
; Внутренний номер определен
exten => s,n(resolved),Noop(CallMe: Ring resolved extension ${CALLME_EXT_RAW} on channel ${CHANNEL(name)})
; КРИТИЧНО: Устанавливаем CALLME_CARD_STATE=RING:<intNum> на реальном SIP-канале
; Это создаст VarSetEvent, который обработает CallMeIn.php и покажет карточку
exten => s,n,Set(__CALLME_CARD_STATE=RING:${CALLME_EXT_RAW})
exten => s,n(return),Return()

;================================================================================
; 6. HOOK: ОБРАБОТКА ANSWER на реальном SIP-канале
; Вызывается через Dial опцию g на созданном SIP-канале при ANSWER
; Устанавливает CALLME_CARD_STATE=SHOW:<intNum> на реальном SIP-канале
;================================================================================

[sub-callme-answer]
exten => s,1,Noop(CallMe: Answer hook triggered on real SIP channel ${CHANNEL(name)})
; Извлекаем внутренний номер (аналогично sub-callme-ring)
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CHANNEL(name),/,2)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved)
exten => s,n,Set(CALLME_EXT_RAW=${CONNECTEDLINE(num)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved:return)
; Внутренний номер определен
exten => s,n(resolved),Noop(CallMe: Answer resolved extension ${CALLME_EXT_RAW} on channel ${CHANNEL(name)})
; КРИТИЧНО: Устанавливаем CALLME_CARD_STATE=SHOW:<intNum> на реальном SIP-канале
; CallMeIn.php обработает VarSetEvent, покажет карточку ответившему и скроет у остальных
exten => s,n,Set(__CALLME_CARD_STATE=SHOW:${CALLME_EXT_RAW})
exten => s,n(return),Return()

;================================================================================
; 7. HOOK: ОБРАБОТКА HANGUP на реальном SIP-канале
; Вызывается через Dial опцию h на созданном SIP-канале при HANGUP
; Устанавливает CALLME_CARD_STATE=HIDE:<intNum> на реальном SIP-канале
;================================================================================

[sub-callme-hangup]
exten => s,1,Noop(CallMe: Hangup hook triggered on real SIP channel ${CHANNEL(name)})
; Извлекаем внутренний номер (аналогично sub-callme-ring)
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CHANNEL(name),/,2)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved)
exten => s,n,Set(CALLME_EXT_RAW=${CONNECTEDLINE(num)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved:return)
; Внутренний номер определен
exten => s,n(resolved),Noop(CallMe: Hangup resolved extension ${CALLME_EXT_RAW} on channel ${CHANNEL(name)})
; КРИТИЧНО: Устанавливаем CALLME_CARD_STATE=HIDE:<intNum> на реальном SIP-канале
; CallMeIn.php обработает VarSetEvent и скроет карточку
exten => s,n,Set(__CALLME_CARD_STATE=HIDE:${CALLME_EXT_RAW})
exten => s,n(return),Return()

;================================================================================
; 8. HOOK: ОБНОВЛЕНИЕ CONNECTEDLINE (ИМЯ КЛИЕНТА)
; Примечание: Этот контекст больше не используется напрямую через Dial опции
; Оставлен для совместимости и возможного использования в будущем
; Подставляет имя клиента из CRM в CallerID
;================================================================================

[sub-callme-connectedline]
exten => s,1,Noop(CallMe: ConnectedLine update on ${CHANNEL(name)})
; Получаем имя клиента из аргумента или переменной
exten => s,n,Set(CALLME_CL_NAME=${IF($[${LEN(${ARG1})}]?${ARG1}:${CALLME_CONNECTEDLINE_NAME})})
; Получаем источник (канал входящего звонка)
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${ARG2})}]?${ARG2}:${CALLME_INGRESS_CHANNEL})})
; Пробуем получить из SHARED переменной (устанавливается в NewChannelEvent)
exten => s,n,ExecIf($[${LEN(${CALLME_CL_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CL_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
exten => s,n,Noop(CallMe: ConnectedLine resolved name: ${CALLME_CL_NAME} (source=${CALLME_CL_SOURCE}))
; Если имя не определено - выходим
exten => s,n,ExecIf($[${LEN(${CALLME_CL_NAME})}=0]?Return())
; Устанавливаем имя в CallerID
exten => s,n,Set(CALLERID(name)=${CALLME_CL_NAME})
; Устанавливаем имя в ConnectedLine
exten => s,n,Set(CONNECTEDLINE(name,i)=${CALLME_CL_NAME})
exten => s,n,Set(CONNECTEDLINE(name-pres)=allowed_not_screened)
; Принудительно обновляем ConnectedLine
exten => s,n,Set(CHANNEL(update_connected_line)=yes)
; Отправляем UserEvent для CallMeIn.php (опционально, для логирования)
exten => s,n,UserEvent(CallMeConnectedLineUpdate,Linkedid:${CHANNEL(linkedid)},TargetChannel:${CHANNEL(name)},Name:${CALLME_CL_NAME})
exten => s,n,Return()

;================================================================================
; 9. СТАНДАРТНЫЕ ОБРАБОТЧИКИ FreePBX (screen, call forward, DND и т.д.)
;================================================================================

exten => screen,1,GotoIf($["${DB(AMPUSER/${DEXTEN}/screen)}"!="nomemory" | "${CALLERID(number)}"=""]?memory)
exten => screen,n,Set(CALLME_TMP_CNUM=${IF($["${CALLERID(number)}"=""]?"_":${CALLERID(number)})})
exten => screen,n,Set(CALLME_TMP_ALPHA=${REGEX("^[0-9a-zA-Z ]+$" "${CALLME_TMP_CNUM}")})
exten => screen,n,ExecIf($["${CALLME_TMP_ALPHA}"="1"]?System(rm -f ${ASTVARLIBDIR}/sounds/priv-callerintros/${CALLERID(number)}.*))
exten => screen,n(memory),Set(__SCREEN=${DB(AMPUSER/${DEXTEN}/screen)})
exten => screen,n,Set(__SCREEN_EXTEN=${DEXTEN})
exten => screen,n,Set(ARG2=${ARG2}p)
exten => screen,n,Return()

exten => cf,1,Set(CFAMPUSER=${IF($["${AMPUSER}"=""]?${CALLERID(number)}:${AMPUSER})})
exten => cf,n,ExecIf($["${DB(CF/${DEXTEN})}"="${CFAMPUSER}" | "${DB(CF/${DEXTEN})}"="${REALCALLERIDNUM}" | "${CUT(CUT(${BLINDTRANSFER},-,1),/,1)}" = "${DB(CF/${DEXTEN})}" | "${DEXTEN}"="${DB(CF/${DEXTEN})}"]?Return())
exten => cf,n,ExecIf($["${DB(AMPUSER/${DEXTEN}/cfringtimer)}" != "0" & "${DB(AMPUSER/${DEXTEN}/cfringtimer)}" != ""]?Set(ARG1=${IF($["${DB(AMPUSER/${DEXTEN}/cfringtimer)}"="-1"]?"":${DB(AMPUSER/${DEXTEN}/cfringtimer)})}))
exten => cf,n,Set(DEXTEN=${IF($["${CFIGNORE}"=""]?"${DB(CF/${DEXTEN})}#":"")})
exten => cf,n,ExecIf($["${DEXTEN}"!=""]?Return())
exten => cf,n,Set(DIALSTATUS=NOANSWER)
exten => cf,n,Return()

exten => qwait,1,ExecIf($["${SAVEDCIDNAME}" = ""]?Set(__SAVEDCIDNAME=${CALLERID(name)}))
exten => qwait,n,Set(ELAPSED=${MATH($[${EPOCH}+30-${QUEUEWAIT}]/60,int)})
exten => qwait,n,Set(CALLERID(name)=M${ELAPSED}:${SAVEDCIDNAME})
exten => qwait,n,Return()

exten => ctset,1,Set(DB(CALLTRACE/${DEXTEN})=${CALLERID(number)})
exten => ctset,n,Return()

exten => ctclear,1,Noop(Deleting: CALLTRACE/${DEXTEN} ${DB_DELETE(CALLTRACE/${DEXTEN})})
exten => ctclear,n,Return()

exten => dstring,1,Set(DSTRING=)
exten => dstring,n,Set(DEVICES=${DB(AMPUSER/${DEXTEN}/device)})
exten => dstring,n,ExecIf($["${DEVICES}"=""]?Return())
exten => dstring,n,ExecIf($["${DEVICES:0:1}"="&"]?Set(DEVICES=${DEVICES:1}))
exten => dstring,n,Set(LOOPCNT=${FIELDQTY(DEVICES,&)})
exten => dstring,n,Set(ITER=1)
exten => dstring,n(begin),Set(THISDIAL=${DB(DEVICE/${CUT(DEVICES,&,${ITER})}/dial)})
exten => dstring,n,GosubIf($["${ASTCHANDAHDI}" = "1"]?zap2dahdi,1())
exten => dstring,n,Set(DSTRING=${DSTRING}${THISDIAL}&)
exten => dstring,n,Set(ITER=$[${ITER}+1])
exten => dstring,n,GotoIf($[${ITER}<=${LOOPCNT}]?begin)
exten => dstring,n,Set(DSTRING=${DSTRING:0:$[${LEN(${DSTRING})}-1]})
exten => dstring,n,Return()

exten => dlocal,1,Set(DSTRING=${IF($["${ARG1}"=""]?${DEXTEN:0:${MATH(${LEN(${DEXTEN})}-1,int)}}:Local/${DEXTEN:0:${MATH(${LEN(${DEXTEN})}-1,int)}}@from-internal/n)})
exten => dlocal,n,Set(USEGOTO=${IF($["${ARG1}"=""]?1:0)})
exten => dlocal,n,Return()

exten => zap2dahdi,1,ExecIf($["${THISDIAL}" = ""]?Return())
exten => zap2dahdi,n,Set(NEWDIAL=)
exten => zap2dahdi,n,Set(LOOPCNT2=${FIELDQTY(THISDIAL,&)})
exten => zap2dahdi,n,Set(ITER2=1)
exten => zap2dahdi,n(begin2),Set(THISPART2=${CUT(THISDIAL,&,${ITER2})})
exten => zap2dahdi,n,ExecIf($["${THISPART2:0:3}" = "ZAP"]?Set(THISPART2=DAHDI${THISPART2:3}))
exten => zap2dahdi,n,Set(NEWDIAL=${NEWDIAL}${THISPART2}&)
exten => zap2dahdi,n,Set(ITER2=$[${ITER2} + 1])
exten => zap2dahdi,n,GotoIf($[${ITER2} <= ${LOOPCNT2}]?begin2)
exten => zap2dahdi,n,Set(THISDIAL=${NEWDIAL:0:$[${LEN(${NEWDIAL})}-1]})
exten => zap2dahdi,n,Return()

;================================================================================
; 10. ОБРАБОТЧИКИ РЕЗУЛЬТАТОВ DIAL (ANSWER, BUSY, NOANSWER и т.д.)
;================================================================================

exten => s-TORTURE,1,Goto(app-blackhole,musiconhold,1)
exten => s-TORTURE,n,Macro(hangupcall,)

exten => s-DONTCALL,1,Answer
exten => s-DONTCALL,n,Wait(1)
exten => s-DONTCALL,n,Zapateller()
exten => s-DONTCALL,n,Playback(ss-noservice)
exten => s-DONTCALL,n,Macro(hangupcall,)

exten => s-ANSWER,1,Return()
exten => s-ANSWER,n,Return()

exten => s-BUSY,1,Return()
exten => s-BUSY,n,Return()

exten => s-NOANSWER,1,Return()
exten => s-NOANSWER,n,Return()

exten => s-CHANUNAVAIL,1,Return()
exten => s-CHANUNAVAIL,n,Return()

;================================================================================
; КОНЕЦ ФАЙЛА
;================================================================================
; ПРИМЕЧАНИЯ ПО ИНТЕГРАЦИИ:
;
; 1. РЕГИСТРАЦИЯ ЗВОНКА:
;    - Происходит в CallMeIn.php через NewChannelEvent
;    - CallMeIn.php устанавливает CALLME_CALL_ID через SetVar
;    - CallMeIn.php устанавливает CALLME_CONNECTEDLINE_NAME через SHARED переменную
;
; 2. ПОКАЗ КАРТОЧКИ ПРИ RING:
;    - Обрабатывается через NewstateEvent в CallMeIn.php при обнаружении состояния Ringing
;    - CallMeIn.php отслеживает события Newstate с ChannelStateDesc=Ringing на реальных SIP-каналах
;    - При обнаружении CallMeIn.php устанавливает __CALLME_CARD_STATE=RING:<intNum> через SetVar
;    - Это создаёт VarSetEvent, который обрабатывает существующая логика показа карточек
;    - Формат: __CALLME_CARD_STATE=RING:<intNum>
;    - Работает даже когда опции Dial b()/B() не выполняются (например, в очередях через Local-каналы)
;
; 3. ПОКАЗ КАРТОЧКИ ПРИ ANSWER:
;    - Обрабатывается в sub-callme-answer на РЕАЛЬНОМ SIP-канале при ANSWER
;    - Макрос вызывается через Dial опцию g на созданном SIP-канале
;    - Устанавливается __CALLME_CARD_STATE=SHOW:<intNum> на реальном SIP-канале
;    - Формат: __CALLME_CARD_STATE=SHOW:<intNum>
;    - CallMeIn.php обрабатывает VarSetEvent, показывает карточку ответившему
;      и скрывает у остальных агентов
;
; 4. СКРЫТИЕ КАРТОЧКИ ПРИ HANGUP:
;    - Обрабатывается в sub-callme-hangup на РЕАЛЬНОМ SIP-канале при HANGUP
;    - Макрос вызывается через Dial опцию h на созданном SIP-канале
;    - Устанавливается __CALLME_CARD_STATE=HIDE:<intNum> на реальном SIP-канале
;    - Формат: __CALLME_CARD_STATE=HIDE:<intNum>
;    - CallMeIn.php обрабатывает VarSetEvent и скрывает карточку
;
; 5. ОТЛИЧИЕ ОТ ПРЕДЫДУЩЕЙ ВЕРСИИ:
;    - УДАЛЕНА вся логика работы с Local-каналами и виртуальными каналами
;    - УДАЛЕНА логика извлечения __CALLME_TARGET на Local-каналах
;    - ВСЯ обработка происходит на РЕАЛЬНЫХ SIP-каналах, созданных Dial-ом
;    - Внутренний номер извлекается из CHANNEL(name) на реальном SIP-канале
;    - Диалплан работает с реальными устройствами, игнорируя виртуальные каналы
;
; 6. ПОДСТАНОВКА ИМЕНИ КЛИЕНТА:
;    - Имя получается из CRM в CallMeIn.php при NewChannelEvent
;    - Сохраняется в SHARED переменной CALLME_CL_NAME
;    - Обновляется через sub-callme-connectedline при ConnectedLine update
;    - Устанавливается в CallerID и ConnectedLine для отображения на телефоне
;
; 7. DIAL ОПЦИИ:
;    - g(sub-callme-answer^s^1) - обработка ANSWER на созданном SIP-канале
;    - h(sub-callme-hangup^s^1) - обработка HANGUP на созданном SIP-канале
;    Примечание: CALLME_CARD_STATE=RING устанавливается через NewstateEvent в CallMeIn.php
;
; 8. ПЕРЕМЕННЫЕ КАНАЛА:
;    - CALLME_LINKEDID - для отслеживания трансферов
;    - CALLME_CALL_ID - ID звонка из Bitrix24
;    - CALLME_CARD_STATE - состояние карточки (RING/SHOW/HIDE) - устанавливается на реальных SIP-каналах
;
;================================================================================
