;================================================================================
; CallMe v2 Integration for FreePBX
; Интеграция с Bitrix24 через AMI события
; Основано на DIALPLAN_INTEGRATION_GUIDE.md и CallMeIn.php
;================================================================================

;================================================================================
; 1. ПОДДЕРЖКА ЗАПИСИ ЗВОНКОВ (наследуется от FreePBX)
;================================================================================

[sub-record-check]
exten => record,1,Gosub(sub-record-check-custom,s,1)
exten => record,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => record,n,MixMonitor(${MIXMON_DIR}${YEAR}/${MONTH}/${DAY}/${CALLFILENAME}.${MON_FMT},,${MIXMON_POST})
exten => record,n,Set(__REC_STATUS=RECORDING)
exten => record,n,Set(CDR(recordingfile)=${CALLFILENAME}.${MON_FMT})
exten => record,n,Return()

exten => recq,1,Gosub(sub-record-check-custom,s,1)
exten => recq,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => recq,n,Set(MONITOR_FILENAME=${MIXMON_DIR}${YEAR}/${MONTH}/${DAY}/${CALLFILENAME})
exten => recq,n,MixMonitor(${MONITOR_FILENAME}.${MON_FMT},${MONITOR_OPTIONS}${MIXMON_BEEP},${MIXMON_POST})
exten => recq,n,Set(__REC_STATUS=RECORDING)
exten => recq,n,Set(CDR(recordingfile)=${CALLFILENAME}.${MON_FMT})
exten => recq,n,Return()

;================================================================================
; 2. ОСНОВНОЙ МАКРОС ДОЗВОНА (macro-dial-one)
; Интеграция CallMe происходит через macro-dial-one-custom
;================================================================================

[macro-dial-one]
include => macro-dial-one-custom
exten => s,1,Set(DEXTEN=${ARG3})
; Сохраняем CALLME_LINKEDID для отслеживания трансферов
exten => s,n,Set(__CALLME_LINKEDID=${IF($["${CALLME_LINKEDID}"=""]?${CHANNEL(linkedid)}:${CALLME_LINKEDID})})
; Сохраняем CALLME_CALL_ID если он уже установлен
exten => s,n,Set(__CALLME_CALL_ID=${CALLME_CALL_ID})
exten => s,n,Set(DIALSTATUS_CW=)
; Вызываем наш custom-хук ПЕРЕД основной логикой FreePBX
exten => s,n,GosubIf($["${DEXTEN}"!=""]?macro-dial-one-custom,s,1(${DEXTEN}))
; Стандартная логика FreePBX (screen, call forward, DND и т.д.)
exten => s,n,GosubIf($["${FROM_DID}"!="" & "${SCREEN}"="" & "${DB(AMPUSER/${DEXTEN}/screen)}"!=""]?screen,1())
exten => s,n,GosubIf($["${DB(CF/${DEXTEN})}"!=""]?cf,1())
exten => s,n,GotoIf($["${DEXTEN:-1}"="#" | "${DB(DND/${DEXTEN})}"=""]?skip1)
exten => s,n,Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=BUSY)
exten => s,n(skip1),GotoIf($["${DEXTEN}"=""]?nodial)
exten => s,n,GotoIf($["${DEXTEN:-1}"="#"]?continue)
exten => s,n,Set(EXTHASCW=${IF($["${CWIGNORE}"!=""]?"":${DB(CW/${DEXTEN})})})
exten => s,n,GotoIf($["${EXTHASCW}"="" | "${DB(CFB/${DEXTEN})}"!="" | "${DB(CFU/${DEXTEN})}"!=""]?next1:cwinusebusy)
exten => s,n(next1),GotoIf($["${DB(CFU/${DEXTEN})}"!="" & ("${EXTENSION_STATE(${DEXTEN})}"="UNAVAILABLE" | "${EXTENSION_STATE(${DEXTEN})}"="UNKNOWN")]?docfu:skip3)
exten => s,n(docfu),Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=NOANSWER)
exten => s,n,Goto(nodial)
exten => s,n(skip3),GotoIf($["${EXTHASCW}"="" | "${DB(CFB/${DEXTEN})}"!=""]?next2:continue)
exten => s,n(next2),GotoIf($["${EXTENSION_STATE(${DEXTEN})}"="NOT_INUSE" | "${EXTENSION_STATE(${DEXTEN})}"="UNAVAILABLE" | "${EXTENSION_STATE(${DEXTEN})}"="UNKNOWN"]?continue)
exten => s,n,ExecIf($["${DB(CFB/${DEXTEN})}"!="" & "${CFIGNORE}"=""]?Set(DIALSTATUS=BUSY))
exten => s,n,GotoIf($["${EXTHASCW}"!="" | "${DEXTEN:-1}"="#"]?cwinusebusy)
exten => s,n,Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=BUSY)
exten => s,n,Goto(nodial)
exten => s,n(cwinusebusy),GotoIf($["${EXTHASCW}"!="" & "${CWINUSEBUSY}"="true"]?next3:continue)
exten => s,n(next3),ExecIf($["${EXTENSION_STATE(${DEXTEN})}"!="UNAVAILABLE" & "${EXTENSION_STATE(${DEXTEN})}"!="NOT_INUSE" & "${EXTENSION_STATE(${DEXTEN})}"!="UNKNOWN"]?Set(DIALSTATUS_CW=BUSY))
exten => s,n(continue),GotoIf($["${DEXTEN}"=""]?nodial)
exten => s,n,GosubIf($["${DEXTEN:-1}"!="#"]?dstring,1():dlocal,1())
exten => s,n,GotoIf($[${LEN(${DSTRING})}=0]?nodial)
exten => s,n,GotoIf($["${DEXTEN:-1}"="#"]?skiptrace)
exten => s,n(skiptrace),Set(D_OPTIONS=${ARG2})
exten => s,n,ExecIf($["${NODEST}"!="" & "${CALLME_HAS_M}"!="1"]?Set(D_OPTIONS=${D_OPTIONS}M(auto-blkvm)))
exten => s,n,ExecIf($["${NODEST}"!="" & "${CALLME_HAS_M}"!="1"]?Set(CALLME_HAS_M=1))
exten => s,n,ExecIf($["${ALERT_INFO}"!=""]?SIPAddHeader(Alert-Info: ${ALERT_INFO}))
exten => s,n,ExecIf($["${SIPADDHEADER}"!=""]?SIPAddHeader(${SIPADDHEADER}))
exten => s,n,ExecIf($["${MOHCLASS}"!=""]?Set(CHANNEL(musicclass)=${MOHCLASS}))
exten => s,n,GosubIf($["${QUEUEWAIT}"!=""]?qwait,1())
exten => s,n,Set(__CWIGNORE=${CWIGNORE})
exten => s,n,Set(__KEEPCID=TRUE)
exten => s,n,GotoIf($["${USEGOTO}"="1"]?usegoto,1)
exten => s,n,GotoIf($["${DB(AMPUSER/${EXTTOCALL}/cidname)}" = "" | "${DB(AMPUSER/${AMPUSER}/cidname)}" = ""]?godial)
exten => s,n,Set(CONNECTEDLINE(name,i)=${DB(AMPUSER/${EXTTOCALL}/cidname)})
exten => s,n,Set(CONNECTEDLINE(num)=${EXTTOCALL})
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}I)
exten => s,n(godial),NoOp()
; Выполняем Dial с нашими hooks (gU опция вызывает sub-callme-state при RING)
exten => s,n,Dial(${DSTRING},${ARG1},${D_OPTIONS})
; После Dial: обработка результата и типизация звонка
exten => s,n,ExecIf($["${CALLME_RING_SENT}"="1"]?ExecIf($["${CALLME_ROUTE_IS_MULTI}"=""]?Set(__CALLME_ROUTE_IS_MULTI=${IF($["${QAGENT}"!=""]?1:${IF($[${REGEX("from-queue" ${CHANNEL(name)})}]?1:${IF($[${REGEX("from-ringgroups" ${CHANNEL(name)})}]?1:0)})})})}))
exten => s,n,ExecIf($["${CALLME_RING_SENT}"="1"]?ExecIf($["${CALLME_ROUTE_TYPE}"=""]?Set(__CALLME_ROUTE_TYPE=${IF($["${CALLME_ROUTE_IS_MULTI}"="1"]?multi:direct)})))
; Скрываем карточку у неответивших (если был RING, но не ANSWER)
exten => s,n,GotoIf($["${CALLME_RING_SENT}"!="1" | "${DIALSTATUS}"="ANSWER" | "${__CALLME_TARGET}"=""]?skip_hide_state)
exten => s,n,Set(__CALLME_CARD_STATE=HIDE:${__CALLME_TARGET})
exten => s,n(skip_hide_state),NoOp()
exten => s,n,ExecIf($["${CALLME_RING_SENT}"="1"]?Set(__CALLME_RING_SENT=))
exten => s,n,ExecIf($["${DIALSTATUS_CW}"!=""]?Set(DIALSTATUS=${DIALSTATUS_CW}))
exten => s,n,GosubIf($[("${SCREEN}"!=""&( "${DIALSTATUS}"="TORTURE"|"${DIALSTATUS}"="DONTCALL"))|"${DIALSTATUS}"="ANSWER"]?s-${DIALSTATUS},1())
exten => s,n,MacroExit()
exten => s,n(nodial),ExecIf($["${DIALSTATUS}" = ""]?Set(DIALSTATUS=NOANSWER))
exten => s,n,Noop(Returned from dial-one with nothing to call and DIALSTATUS: ${DIALSTATUS})
exten => s,n,MacroExit()

; Hangup extension - скрываем карточку при завершении канала
exten => h,1,ExecIf($[${LEN(${__CALLME_TARGET})}]?Set(__CALLME_CARD_STATE=HIDE:${__CALLME_TARGET}))
exten => h,n,Macro(hangupcall,)

exten => usegoto,1,Set(USEGOTO=)
exten => usegoto,n,Goto(from-internal,${DSTRING},1)

;================================================================================
; 3. CALLME HOOK: ПОДГОТОВКА ПЕРЕД DIAL
; Вызывается ПЕРЕД Dial() для настройки переменных и hooks
;================================================================================

[macro-dial-one-custom]
exten => s,1,Noop(CallMe: Preparing dial hook for ${ARG1})
; Сохраняем linkedid для отслеживания трансферов
exten => s,n,Set(__CALLME_LINKEDID=${IF($["${CALLME_LINKEDID}"=""]?${CHANNEL(linkedid)}:${CALLME_LINKEDID})})
; Определяем целевой внутренний номер
exten => s,n,Set(__CALLME_TARGET=${IF($[${LEN(${ARG1})}]?${ARG1}:${DEXTEN})})
; Если не определили - извлекаем из имени канала
exten => s,n,ExecIf($["${__CALLME_TARGET}"=""]?Set(__CALLME_TARGET=${CUT(CHANNEL(name),/,2)}))
; Очищаем от суффиксов (@from-internal, ;1 и т.д.)
exten => s,n,ExecIf($["${REGEX("@.*" ${__CALLME_TARGET})}" = "1"]?Set(__CALLME_TARGET=${CUT(__CALLME_TARGET,@,1)}))
exten => s,n,Noop(CallMe: Target extension=${__CALLME_TARGET})
; Сохраняем CALL_ID если он уже установлен (из NewChannelEvent)
exten => s,n,Set(__CALLME_CALL_ID=${CALLME_CALL_ID})
; Если CALL_ID не установлен - используем linkedid как временный идентификатор
exten => s,n,ExecIf($["${CALLME_CALL_ID}"=""]?Set(__CALLME_CALL_ID=${CHANNEL(linkedid)}))
; Направление звонка (inbound/outbound)
exten => s,n,Set(__CALLME_DIRECTION=${IF($["${CALLME_DIRECTION}"=""]?inbound:${CALLME_DIRECTION})})
; Уникальный ID агента (для отслеживания в multi-звонках)
exten => s,n,Set(__CALLME_AG_UNIQ=${IF($["${CALLME_AG_UNIQ}"=""]?${UNIQUEID}:${CALLME_AG_UNIQ})})
; ОПРЕДЕЛЕНИЕ ТИПА ЗВОНКА (multi/direct) - КРИТИЧНО для правильной обработки
; Проверяем наличие QAGENT (звонок из очереди)
; Проверяем имя канала на наличие "from-queue" или "from-ringgroups"
exten => s,n,Set(__CALLME_ROUTE_IS_MULTI=${IF($["${CALLME_ROUTE_IS_MULTI}"!=""]?${CALLME_ROUTE_IS_MULTI}:${IF($["${QAGENT}"!=""]?1:${IF($[${REGEX("from-queue" ${CHANNEL(name)})}]?1:${IF($[${REGEX("from-ringgroups" ${CHANNEL(name)})}]?1:0)})})})})
; Устанавливаем тип звонка: multi (очередь/группа) или direct (прямой)
exten => s,n,Set(__CALLME_ROUTE_TYPE=${IF($["${CALLME_ROUTE_TYPE}"!=""]?${CALLME_ROUTE_TYPE}:${IF($["${CALLME_ROUTE_IS_MULTI}"="1"]?multi:direct)})})
; Помечаем что RING-событие будет отправлено
exten => s,n,Set(__CALLME_RING_SENT=1)
; Отправляем RING состояние ПЕРЕД Dial (для multi-звонков через очереди)
; Для direct-звонков это будет обработано в sub-callme-state при RING
exten => s,n,ExecIf($["${__CALLME_ROUTE_TYPE}"="multi" & ${LEN(${__CALLME_TARGET})}]?Set(__CALLME_CARD_STATE=RING:${__CALLME_TARGET}))
; Подготовка ConnectedLine для подстановки имени клиента
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${CALLME_INGRESS_CHANNEL})}]?${CALLME_INGRESS_CHANNEL}:${CHANNEL(name)})})
; Получаем имя из SHARED переменной (устанавливается в NewChannelEvent)
exten => s,n,ExecIf($[${LEN(${CALLME_CONNECTEDLINE_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CONNECTEDLINE_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
exten => s,n,Noop(CallMe: ConnectedLine name='${CALLME_CONNECTEDLINE_NAME}' source='${CALLME_CL_SOURCE}')
; Добавляем hook для обновления ConnectedLine (b опция Dial)
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}b(sub-callme-connectedline^s^1(${CALLME_CONNECTEDLINE_NAME},${CALLME_CL_SOURCE})))
; Добавляем hook для обработки состояния карточки при RING (gU опция Dial - вызывается при RING на каждом канале)
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}gU(sub-callme-state^s^1^${__CALLME_TARGET}))
; Добавляем hook для обработки ANSWER (g опция Dial - вызывается при ANSWER)
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}g(sub-callme-answer^s^1^${__CALLME_TARGET}))
exten => s,n,Return()

;================================================================================
; 4. HOOK: ОБРАБОТКА СОСТОЯНИЯ КАРТОЧКИ ПРИ RING
; Вызывается через Dial опцию gU при каждом RING на канале
; Отправляет VarSetEvent с __CALLME_CARD_STATE для CallMeIn.php
;================================================================================

[sub-callme-state]
exten => s,1,Noop(CallMe: State hook triggered on ${CHANNEL(name)})
; Извлекаем внутренний номер из различных источников
exten => s,n,Set(CALLME_EXT_RAW=${IF($[${LEN(${__CALLME_TARGET})}]?${__CALLME_TARGET}:"")})
; Пробуем извлечь из имени канала
exten => s,n,ExecIf($["${CALLME_EXT_RAW}"=""]?Set(CALLME_EXT_RAW=${CUT(CHANNEL(name),/,2)}))
; Очищаем от суффиксов
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
; Проверяем что это валидный внутренний номер (2-6 цифр)
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved)
; Если не нашли - пробуем из CONNECTEDLINE
exten => s,n,Set(CALLME_EXT_RAW=${CONNECTEDLINE(num)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved:return)
; Внутренний номер определен
exten => s,n(resolved),Noop(CallMe: Resolved extension ${CALLME_EXT_RAW})
; Сохраняем номер агента
exten => s,n,Set(__CALLME_AGENT=${CALLME_EXT_RAW})
; Fallback: используем __CALLME_TARGET если не определили
exten => s,n,ExecIf($["${CALLME_AGENT}"=""]?Set(__CALLME_AGENT=${__CALLME_TARGET}))
; Fallback: извлекаем из имени канала
exten => s,n,ExecIf($["${CALLME_AGENT}"=""]?Set(__CALLME_AGENT=${CUT(CHANNEL(name),/,2)}))
; Устанавливаем направление звонка если не установлено
exten => s,n,ExecIf($["${CALLME_DIRECTION}"=""]?Set(__CALLME_DIRECTION=inbound))
; Устанавливаем linkedid если не установлен
exten => s,n,ExecIf($[${LEN(${CALLME_LINKEDID})}=0]?Set(CALLME_LINKEDID=${CHANNEL(linkedid)}))
; Устанавливаем уникальный ID агента если не установлен
exten => s,n,ExecIf($[${LEN(${CALLME_AG_UNIQ})}=0]?Set(CALLME_AG_UNIQ=${UNIQUEID}))
; Повторная проверка типа звонка (на случай если не определили ранее)
exten => s,n,ExecIf($["${CALLME_ROUTE_IS_MULTI}"=""]?Set(__CALLME_ROUTE_IS_MULTI=${IF($["${QAGENT}"!=""]?1:${IF($[${REGEX("from-queue" ${CHANNEL(name)})}]?1:${IF($[${REGEX("from-ringgroups" ${CHANNEL(name)})}]?1:0)})})})})
exten => s,n,ExecIf($["${CALLME_ROUTE_TYPE}"=""]?Set(__CALLME_ROUTE_TYPE=${IF($["${CALLME_ROUTE_IS_MULTI}"="1"]?multi:direct)}))
; КРИТИЧНО: Отправляем VarSetEvent с состоянием RING при начале звонка
; CallMeIn.php обработает это событие и покажет карточку всем звонящим
; Для direct-звонков это происходит здесь, для multi - в macro-dial-one-custom
exten => s,n,Set(__CALLME_CARD_STATE=RING:${CALLME_EXT_RAW})
; Регистрируем hangup handler для скрытия карточки при завершении
exten => s,n,Set(CHANNEL(hangup_handler_push)=hangup-callme-operator,s,1(${CALLME_EXT_RAW}))
exten => s,n(return),Return()

;================================================================================
; 4.1. HOOK: ОБРАБОТКА ANSWER (когда агент снял трубку)
; Вызывается через Dial опцию g при ANSWER
; Отправляет VarSetEvent с состоянием SHOW для ответившего агента
;================================================================================

[sub-callme-answer]
exten => s,1,Noop(CallMe: Answer hook triggered on ${CHANNEL(name)})
; Извлекаем внутренний номер (аналогично sub-callme-state)
exten => s,n,Set(CALLME_EXT_RAW=${IF($[${LEN(${ARG1})}]?${ARG1}:"")})
exten => s,n,ExecIf($["${CALLME_EXT_RAW}"=""]?Set(CALLME_EXT_RAW=${CUT(CHANNEL(name),/,2)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved)
exten => s,n,Set(CALLME_EXT_RAW=${CONNECTEDLINE(num)})
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,;,1)}))
exten => s,n,ExecIf($[${LEN(${CALLME_EXT_RAW})}]?Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)}))
exten => s,n,Set(CALLME_TMP_OK=${REGEX("^[0-9]{2,6}$" "${CALLME_EXT_RAW}")})
exten => s,n,GotoIf($["${CALLME_TMP_OK}"="1"]?resolved:return)
; Внутренний номер определен
exten => s,n(resolved),Noop(CallMe: Answer resolved extension ${CALLME_EXT_RAW})
; КРИТИЧНО: Отправляем VarSetEvent с состоянием SHOW для ответившего агента
; CallMeIn.php обработает это событие, покажет карточку ответившему и скроет у остальных
exten => s,n,Set(__CALLME_CARD_STATE=SHOW:${CALLME_EXT_RAW})
exten => s,n(return),Return()

;================================================================================
; 5. HOOK: СКРЫТИЕ КАРТОЧКИ ПРИ ЗАВЕРШЕНИИ КАНАЛА
; Вызывается через hangup_handler при завершении канала
;================================================================================

[hangup-callme-operator]
exten => s,1,ExecIf($[${LEN(${ARG1})}=0]?Return())
; Отправляем VarSetEvent для скрытия карточки
exten => s,n,Set(__CALLME_CARD_STATE=HIDE:${ARG1})
exten => s,n,Return()

;================================================================================
; 6. HOOK: ОБНОВЛЕНИЕ CONNECTEDLINE (ИМЯ КЛИЕНТА)
; Вызывается через Dial опцию b при обновлении ConnectedLine
; Подставляет имя клиента из CRM в CallerID
;================================================================================

[sub-callme-connectedline]
exten => s,1,Noop(CallMe: ConnectedLine update on ${CHANNEL(name)})
; Получаем имя клиента из аргумента или переменной
exten => s,n,Set(CALLME_CL_NAME=${IF($[${LEN(${ARG1})}]?${ARG1}:${CALLME_CONNECTEDLINE_NAME})})
; Получаем источник (канал входящего звонка)
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${ARG2})}]?${ARG2}:${CALLME_INGRESS_CHANNEL})})
; Пробуем получить из SHARED переменной (устанавливается в NewChannelEvent)
exten => s,n,ExecIf($[${LEN(${CALLME_CL_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CL_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
exten => s,n,Noop(CallMe: ConnectedLine resolved name: ${CALLME_CL_NAME} (source=${CALLME_CL_SOURCE}))
; Если имя не определено - выходим
exten => s,n,ExecIf($[${LEN(${CALLME_CL_NAME})}=0]?Return())
; Устанавливаем имя в CallerID
exten => s,n,Set(CALLERID(name)=${CALLME_CL_NAME})
; Устанавливаем имя в ConnectedLine
exten => s,n,Set(CONNECTEDLINE(name,i)=${CALLME_CL_NAME})
exten => s,n,Set(CONNECTEDLINE(name-pres)=allowed_not_screened)
; Принудительно обновляем ConnectedLine
exten => s,n,Set(CHANNEL(update_connected_line)=yes)
; Отправляем UserEvent для CallMeIn.php (опционально, для логирования)
exten => s,n,UserEvent(CallMeConnectedLineUpdate,Linkedid:${CHANNEL(linkedid)},TargetChannel:${CHANNEL(name)},Name:${CALLME_CL_NAME})
exten => s,n,Return()

;================================================================================
; 7. СТАНДАРТНЫЕ ОБРАБОТЧИКИ FreePBX (screen, call forward, DND и т.д.)
;================================================================================

exten => screen,1,GotoIf($["${DB(AMPUSER/${DEXTEN}/screen)}"!="nomemory" | "${CALLERID(number)}"=""]?memory)
exten => screen,n,Set(CALLME_TMP_CNUM=${IF($["${CALLERID(number)}"=""]?"_":${CALLERID(number)})})
exten => screen,n,Set(CALLME_TMP_ALPHA=${REGEX("^[0-9a-zA-Z ]+$" "${CALLME_TMP_CNUM}")})
exten => screen,n,ExecIf($["${CALLME_TMP_ALPHA}"="1"]?System(rm -f ${ASTVARLIBDIR}/sounds/priv-callerintros/${CALLERID(number)}.*))
exten => screen,n(memory),Set(__SCREEN=${DB(AMPUSER/${DEXTEN}/screen)})
exten => screen,n,Set(__SCREEN_EXTEN=${DEXTEN})
exten => screen,n,Set(ARG2=${ARG2}p)
exten => screen,n,Return()

exten => cf,1,Set(CFAMPUSER=${IF($["${AMPUSER}"=""]?${CALLERID(number)}:${AMPUSER})})
exten => cf,n,ExecIf($["${DB(CF/${DEXTEN})}"="${CFAMPUSER}" | "${DB(CF/${DEXTEN})}"="${REALCALLERIDNUM}" | "${CUT(CUT(${BLINDTRANSFER},-,1),/,1)}" = "${DB(CF/${DEXTEN})}" | "${DEXTEN}"="${DB(CF/${DEXTEN})}"]?Return())
exten => cf,n,ExecIf($["${DB(AMPUSER/${DEXTEN}/cfringtimer)}" != "0" & "${DB(AMPUSER/${DEXTEN}/cfringtimer)}" != ""]?Set(ARG1=${IF($["${DB(AMPUSER/${DEXTEN}/cfringtimer)}"="-1"]?"":${DB(AMPUSER/${DEXTEN}/cfringtimer)})}))
exten => cf,n,Set(DEXTEN=${IF($["${CFIGNORE}"=""]?"${DB(CF/${DEXTEN})}#":"")})
exten => cf,n,ExecIf($["${DEXTEN}"!=""]?Return())
exten => cf,n,Set(DIALSTATUS=NOANSWER)
exten => cf,n,Return()

exten => qwait,1,ExecIf($["${SAVEDCIDNAME}" = ""]?Set(__SAVEDCIDNAME=${CALLERID(name)}))
exten => qwait,n,Set(ELAPSED=${MATH($[${EPOCH}+30-${QUEUEWAIT}]/60,int)})
exten => qwait,n,Set(CALLERID(name)=M${ELAPSED}:${SAVEDCIDNAME})
exten => qwait,n,Return()

exten => ctset,1,Set(DB(CALLTRACE/${DEXTEN})=${CALLERID(number)})
exten => ctset,n,Return()

exten => ctclear,1,Noop(Deleting: CALLTRACE/${DEXTEN} ${DB_DELETE(CALLTRACE/${DEXTEN})})
exten => ctclear,n,Return()

exten => dstring,1,Set(DSTRING=)
exten => dstring,n,Set(DEVICES=${DB(AMPUSER/${DEXTEN}/device)})
exten => dstring,n,ExecIf($["${DEVICES}"=""]?Return())
exten => dstring,n,ExecIf($["${DEVICES:0:1}"="&"]?Set(DEVICES=${DEVICES:1}))
exten => dstring,n,Set(LOOPCNT=${FIELDQTY(DEVICES,&)})
exten => dstring,n,Set(ITER=1)
exten => dstring,n(begin),Set(THISDIAL=${DB(DEVICE/${CUT(DEVICES,&,${ITER})}/dial)})
exten => dstring,n,GosubIf($["${ASTCHANDAHDI}" = "1"]?zap2dahdi,1())
exten => dstring,n,Set(DSTRING=${DSTRING}${THISDIAL}&)
exten => dstring,n,Set(ITER=$[${ITER}+1])
exten => dstring,n,GotoIf($[${ITER}<=${LOOPCNT}]?begin)
exten => dstring,n,Set(DSTRING=${DSTRING:0:$[${LEN(${DSTRING})}-1]})
exten => dstring,n,Return()

exten => dlocal,1,Set(DSTRING=${IF($["${ARG1}"=""]?${DEXTEN:0:${MATH(${LEN(${DEXTEN})}-1,int)}}:Local/${DEXTEN:0:${MATH(${LEN(${DEXTEN})}-1,int)}}@from-internal/n)})
exten => dlocal,n,Set(USEGOTO=${IF($["${ARG1}"=""]?1:0)})
exten => dlocal,n,Return()

exten => zap2dahdi,1,ExecIf($["${THISDIAL}" = ""]?Return())
exten => zap2dahdi,n,Set(NEWDIAL=)
exten => zap2dahdi,n,Set(LOOPCNT2=${FIELDQTY(THISDIAL,&)})
exten => zap2dahdi,n,Set(ITER2=1)
exten => zap2dahdi,n(begin2),Set(THISPART2=${CUT(THISDIAL,&,${ITER2})})
exten => zap2dahdi,n,ExecIf($["${THISPART2:0:3}" = "ZAP"]?Set(THISPART2=DAHDI${THISPART2:3}))
exten => zap2dahdi,n,Set(NEWDIAL=${NEWDIAL}${THISPART2}&)
exten => zap2dahdi,n,Set(ITER2=$[${ITER2} + 1])
exten => zap2dahdi,n,GotoIf($[${ITER2} <= ${LOOPCNT2}]?begin2)
exten => zap2dahdi,n,Set(THISDIAL=${NEWDIAL:0:$[${LEN(${NEWDIAL})}-1]})
exten => zap2dahdi,n,Return()

;================================================================================
; 8. ОБРАБОТЧИКИ РЕЗУЛЬТАТОВ DIAL (ANSWER, BUSY, NOANSWER и т.д.)
;================================================================================

exten => s-TORTURE,1,Goto(app-blackhole,musiconhold,1)
exten => s-TORTURE,n,Macro(hangupcall,)

exten => s-DONTCALL,1,Answer
exten => s-DONTCALL,n,Wait(1)
exten => s-DONTCALL,n,Zapateller()
exten => s-DONTCALL,n,Playback(ss-noservice)
exten => s-DONTCALL,n,Macro(hangupcall,)

exten => s-ANSWER,1,Return()
exten => s-ANSWER,n,Return()

exten => s-BUSY,1,Return()
exten => s-BUSY,n,Return()

exten => s-NOANSWER,1,Return()
exten => s-NOANSWER,n,Return()

exten => s-CHANUNAVAIL,1,Return()
exten => s-CHANUNAVAIL,n,Return()

;================================================================================
; КОНЕЦ ФАЙЛА
;================================================================================
; ПРИМЕЧАНИЯ ПО ИНТЕГРАЦИИ:
;
; 1. РЕГИСТРАЦИЯ ЗВОНКА:
;    - Происходит в CallMeIn.php через NewChannelEvent
;    - CallMeIn.php устанавливает CALLME_CALL_ID через SetVar
;    - CallMeIn.php устанавливает CALLME_CONNECTEDLINE_NAME через SHARED переменную
;
; 2. ПОКАЗ КАРТОЧКИ ПРИ RING:
;    - Для multi-звонков: отправляется в macro-dial-one-custom (строка 142)
;    - Для direct-звонков: отправляется в sub-callme-state при RING (строка 202)
;    - Формат: __CALLME_CARD_STATE=RING:<intNum>
;    - CallMeIn.php обрабатывает через VarSetEvent и показывает карточку всем звонящим
;
; 3. ПОКАЗ КАРТОЧКИ ПРИ ANSWER:
;    - Отправляется в sub-callme-answer при ANSWER (строка 233)
;    - Формат: __CALLME_CARD_STATE=SHOW:<intNum>
;    - CallMeIn.php обрабатывает через VarSetEvent, показывает карточку ответившему
;      и скрывает у остальных агентов
;
; 4. СКРЫТИЕ КАРТОЧКИ ПРИ HANGUP:
;    - Отправляется в hangup-callme-operator при завершении канала (строка 245)
;    - Формат: __CALLME_CARD_STATE=HIDE:<intNum>
;    - CallMeIn.php обрабатывает через VarSetEvent и скрывает карточку
;
; 5. ТИПИЗАЦИЯ ЗВОНКОВ (multi/direct):
;    - Определяется в macro-dial-one-custom (строки 135-137)
;    - Проверяется наличие QAGENT, "from-queue", "from-ringgroups" в имени канала
;    - Сохраняется в CALLME_ROUTE_TYPE (multi или direct)
;    - Используется CallMeIn.php для выбора правильной логики обработки
;
; 6. ПОДСТАНОВКА ИМЕНИ КЛИЕНТА:
;    - Имя получается из CRM в CallMeIn.php при NewChannelEvent
;    - Сохраняется в SHARED переменной CALLME_CL_NAME
;    - Обновляется через sub-callme-connectedline при ConnectedLine update
;    - Устанавливается в CallerID и ConnectedLine для отображения на телефоне
;
; 7. DIAL ОПЦИИ:
;    - b(sub-callme-connectedline^s^1(...)) - обновление ConnectedLine
;    - gU(sub-callme-state^s^1^...) - обработка RING на каждом канале
;    - g(sub-callme-answer^s^1^...) - обработка ANSWER
;
; 8. ПЕРЕМЕННЫЕ КАНАЛА:
;    - CALLME_LINKEDID - для отслеживания трансферов
;    - CALLME_CALL_ID - ID звонка из Bitrix24
;    - CALLME_ROUTE_TYPE - тип звонка (multi/direct)
;    - CALLME_TARGET - целевой внутренний номер
;    - CALLME_CARD_STATE - состояние карточки (RING/SHOW/HIDE)
;
;================================================================================
