[sub-record-check]
exten => record,1,Gosub(sub-record-check-custom,s,1)
exten => record,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => record,n,MixMonitor(${MIXMON_DIR}${YEAR}/${MONTH}/${DAY}/${CALLFILENAME}.${MON_FMT},,${MIXMON_POST})
exten => record,n,Set(__REC_STATUS=RECORDING)
exten => record,n,Set(CDR(recordingfile)=${CALLFILENAME}.${MON_FMT})
exten => record,n,Return()

exten => recq,1,Gosub(sub-record-check-custom,s,1)
exten => recq,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => recq,n,Set(MONITOR_FILENAME=${MIXMON_DIR}${YEAR}/${MONTH}/${DAY}/${CALLFILENAME})
exten => recq,n,MixMonitor(${MONITOR_FILENAME}.${MON_FMT},${MONITOR_OPTIONS}${MIXMON_BEEP},${MIXMON_POST})
exten => recq,n,Set(__REC_STATUS=RECORDING)
exten => recq,n,Set(CDR(recordingfile)=${CALLFILENAME}.${MON_FMT})
exten => recq,n,Return()

[macro-dial-one]
include => macro-dial-one-custom
exten => s,1,Set(DEXTEN=${ARG3})
; Для multi-звонков (очереди) нужно использовать исходный linkedid основного канала
; Пытаемся найти исходный linkedid через CallMeLINKEDID (устанавливается в b24_continuous_parallel.conf)
; или через GLOBAL переменные, или используем текущий linkedid как fallback
exten => s,n,Set(__CALLME_LINKEDID=${IF($["${CALLME_LINKEDID}"=""]?${IF($["${CallMeLINKEDID}"!=""]?${CallMeLINKEDID}:${CHANNEL(linkedid)}):${CALLME_LINKEDID})})
exten => s,n,Set(CALLME_ROUTE_IS_MULTI=${IF($["${QAGENT}"!=""]?1:${IF($[${REGEX("from-queue" ${CHANNEL(name)})}]?1:${IF($[${REGEX("from-ringgroups" ${CHANNEL(name)})}]?1:0)})})})
; Для multi-звонков пытаемся найти исходный linkedid через GLOBAL переменные из b24_continuous_parallel.conf
exten => s,n,ExecIf($["${CALLME_ROUTE_IS_MULTI}"="1"]?Set(__CALLME_LINKEDID=${IF($["${CallMeLINKEDID}"!=""]?${CallMeLINKEDID}:${IF($["${GLOBAL(ORIGINAL_LINKEDID_BY_CID_${FILTER(0-9,${CALLERID(number)})})}"!=""]?${GLOBAL(ORIGINAL_LINKEDID_BY_CID_${FILTER(0-9,${CALLERID(number)})})}:${CALLME_LINKEDID})})}))
exten => s,n,Set(__CALLME_CALL_ID=${CALLME_CALL_ID})
exten => s,n,Set(__CALLME_ROUTE_TYPE=${IF($["${CALLME_ROUTE_TYPE}"!=""]?${CALLME_ROUTE_TYPE}:${IF($["${CALLME_ROUTE_IS_MULTI}"="1"]?multi:direct)})})
exten => s,n,Set(CALLME_ROUTE_IS_MULTI=)
exten => s,n,Set(DIALSTATUS_CW=)
exten => s,n,GosubIf($["${FROM_DID}"!="" & "${SCREEN}"="" & "${DB(AMPUSER/${DEXTEN}/screen)}"!=""]?screen,1())
exten => s,n,GosubIf($["${DB(CF/${DEXTEN})}"!=""]?cf,1())
exten => s,n,GotoIf($["${DEXTEN:-1}"="#" | "${DB(DND/${DEXTEN})}"=""]?skip1)
exten => s,n,Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=BUSY)
exten => s,n(skip1),GotoIf($["${DEXTEN}"=""]?nodial)
exten => s,n,GotoIf($["${DEXTEN:-1}"="#"]?continue)
exten => s,n,Set(EXTHASCW=${IF($["${CWIGNORE}"!=""]? :${DB(CW/${DEXTEN})})})
exten => s,n,GotoIf($["${EXTHASCW}"="" | "${DB(CFB/${DEXTEN})}"!="" | "${DB(CFU/${DEXTEN})}"!=""]?next1:cwinusebusy)
exten => s,n(next1),GotoIf($["${DB(CFU/${DEXTEN})}"!="" & ("${EXTENSION_STATE(${DEXTEN})}"="UNAVAILABLE" | "${EXTENSION_STATE(${DEXTEN})}"="UNKNOWN")]?docfu:skip3)
exten => s,n(docfu),Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=NOANSWER)
exten => s,n,Goto(nodial)
exten => s,n(skip3),GotoIf($["${EXTHASCW}"="" | "${DB(CFB/${DEXTEN})}"!=""]?next2:continue)
exten => s,n(next2),GotoIf($["${EXTENSION_STATE(${DEXTEN})}"="NOT_INUSE" | "${EXTENSION_STATE(${DEXTEN})}"="UNAVAILABLE" | "${EXTENSION_STATE(${DEXTEN})}"="UNKNOWN"]?continue)
exten => s,n,ExecIf($["${DB(CFB/${DEXTEN})}"!="" & "${CFIGNORE}"=""]?Set(DIALSTATUS=BUSY))
exten => s,n,GotoIf($["${EXTHASCW}"!="" | "${DEXTEN:-1}"="#"]?cwinusebusy)
exten => s,n,Set(DEXTEN=)
exten => s,n,Set(DIALSTATUS=BUSY)
exten => s,n,Goto(nodial)
exten => s,n(cwinusebusy),GotoIf($["${EXTHASCW}"!="" & "${CWINUSEBUSY}"="true"]?next3:continue)
exten => s,n(next3),ExecIf($["${EXTENSION_STATE(${DEXTEN})}"!="UNAVAILABLE" & "${EXTENSION_STATE(${DEXTEN})}"!="NOT_INUSE" & "${EXTENSION_STATE(${DEXTEN})}"!="UNKNOWN"]?Set(DIALSTATUS_CW=BUSY))
exten => s,n(continue),GotoIf($["${DEXTEN}"=""]?nodial)
exten => s,n,GosubIf($["${DEXTEN:-1}"!="#"]?dstring,1():dlocal,1())
exten => s,n,GotoIf($[${LEN(${DSTRING})}=0]?nodial)
exten => s,n,GotoIf($["${DEXTEN:-1}"="#"]?skiptrace)
exten => s,n(skiptrace),Set(D_OPTIONS=${ARG2})
exten => s,n,ExecIf($["${NODEST}"!="" & "${CALLME_HAS_M}"!="1"]?Set(D_OPTIONS=${D_OPTIONS}M(auto-blkvm)))
exten => s,n,ExecIf($["${NODEST}"!="" & "${CALLME_HAS_M}"!="1"]?Set(CALLME_HAS_M=1))
exten => s,n,ExecIf($["${ALERT_INFO}"!=""]?SIPAddHeader(Alert-Info: ${ALERT_INFO}))
exten => s,n,ExecIf($["${SIPADDHEADER}"!=""]?SIPAddHeader(${SIPADDHEADER}))
exten => s,n,ExecIf($["${MOHCLASS}"!=""]?Set(CHANNEL(musicclass)=${MOHCLASS}))
exten => s,n,GosubIf($["${QUEUEWAIT}"!=""]?qwait,1())
exten => s,n,Set(__CWIGNORE=${CWIGNORE})
exten => s,n,Set(__KEEPCID=TRUE)
exten => s,n,GotoIf($["${USEGOTO}"="1"]?usegoto,1)
exten => s,n,GotoIf($["${DB(AMPUSER/${EXTTOCALL}/cidname)}" = "" || "${DB(AMPUSER/${AMPUSER}/cidname)}" = ""]?godial)
exten => s,n,Set(CONNECTEDLINE(name,i)=${DB(AMPUSER/${EXTTOCALL}/cidname)})
exten => s,n,Set(CONNECTEDLINE(num)=${EXTTOCALL})
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}I)
exten => s,n(godial),GosubIf($["${ARG3}"!=""]?macro-dial-one-custom,s,1(${ARG3}))
; CHANNEL(hangup_handler_push) отсутствует в Asterisk 1.8, поэтому
; используем h-экстеншен для постобработки (см. ниже).
exten => s,n,Dial(${DSTRING},${ARG1},${D_OPTIONS})
exten => s,n,ExecIf($["${CALLME_RING_SENT}"="1"]?UserEvent(CallMeRingingStop,Linkedid: ${CALLME_LINKEDID},Target: ${CALLME_TARGET},AgentUniqueid: ${CALLME_AG_UNIQ},Direction: ${CALLME_DIRECTION},DialStatus: ${DIALSTATUS},CallId: ${CALLME_CALL_ID},RouteType: ${CALLME_ROUTE_TYPE}))
exten => s,n,ExecIf($["${CALLME_RING_SENT}"="1"]?Set(__CALLME_RING_SENT=))
exten => s,n,ExecIf($["${DIALSTATUS_CW}"!=""]?Set(DIALSTATUS=${DIALSTATUS_CW}))
exten => s,n,GosubIf($[("${SCREEN}"!=""&( "${DIALSTATUS}"="TORTURE"|"${DIALSTATUS}"="DONTCALL"))|"${DIALSTATUS}"="ANSWER"]?s-${DIALSTATUS},1())
exten => s,n,MacroExit()
exten => s,n(nodial),ExecIf($["${DIALSTATUS}" = ""]?Set(DIALSTATUS=NOANSWER))
exten => s,n,Noop(Returned from dial-one with nothing to call and DIALSTATUS: ${DIALSTATUS})
exten => s,n,MacroExit()

exten => h,1,Set(CALLME_HANGUP_EXT_RAW=${IF($[${LEN(${CALLME_AGENT})}]?${CALLME_AGENT}:${CALLME_TARGET})})
exten => h,n,Set(CALLME_HANGUP_CHAN_EXT=${FILTER(0-9,${CUT(CHANNEL(name),/,2)})})
exten => h,n,Set(CALLME_HANGUP_EXT=${IF($[${LEN(${CALLME_HANGUP_CHAN_EXT})}]?${CALLME_HANGUP_CHAN_EXT}:${CALLME_HANGUP_EXT_RAW})})
exten => h,n,Gosub(sub-callme-hangup,s,1(${CALLME_HANGUP_EXT}))
exten => h,n,ExecIf($[${LEN(${CALLME_HANGUP_EXT})}]?Gosub(hangup-callme-operator,s,1(${CALLME_HANGUP_EXT})))
exten => h,n,Macro(hangupcall,)

exten => usegoto,1,Set(USEGOTO=)
exten => usegoto,n,Goto(from-internal,${DSTRING},1)

exten => screen,1,GotoIf($["${DB(AMPUSER/${DEXTEN}/screen)}"!="nomemory" | "${CALLERID(number)}"=""]?memory)
exten => screen,n,Set(CALLME_TMP_CNUM=${IF($["${CALLERID(number)}"=""]?"_":${CALLERID(number)})})
exten => screen,n,Set(CALLME_TMP_ALPHA=${REGEX("^[0-9a-zA-Z ]+$" "${CALLME_TMP_CNUM}")})
exten => screen,n,ExecIf($["${CALLME_TMP_ALPHA}"="1"]?System(rm -f ${ASTVARLIBDIR}/sounds/priv-callerintros/${CALLERID(number)}.*))
exten => screen,n(memory),Set(__SCREEN=${DB(AMPUSER/${DEXTEN}/screen)})
exten => screen,n,Set(__SCREEN_EXTEN=${DEXTEN})
exten => screen,n,Set(ARG2=${ARG2}p)
exten => screen,n,Return()

exten => cf,1,Set(CFAMPUSER=${IF($["${AMPUSER}"=""]?${CALLERID(number)}:${AMPUSER})})
exten => cf,n,ExecIf($["${DB(CF/${DEXTEN})}"="${CFAMPUSER}" | "${DB(CF/${DEXTEN})}"="${REALCALLERIDNUM}" | "${CUT(CUT(BLINDTRANSFER,-,1),/,1)}" = "${DB(CF/${DEXTEN})}" | "${DEXTEN}"="${DB(CF/${DEXTEN})}"]?Return())
exten => cf,n,ExecIf($["${DB(AMPUSER/${DEXTEN}/cfringtimer)}" != "0" & "${DB(AMPUSER/${DEXTEN}/cfringtimer)}" != ""]?Set(ARG1=${IF($["${DB(AMPUSER/${DEXTEN}/cfringtimer)}"="-1"]? : ${DB(AMPUSER/${DEXTEN}/cfringtimer)})}))
exten => cf,n,Set(DEXTEN=${IF($["${CFIGNORE}"=""]?"${DB(CF/${DEXTEN})}#": )})
exten => cf,n,ExecIf($["${DEXTEN}"!=""]?Return())
exten => cf,n,Set(DIALSTATUS=NOANSWER)
exten => cf,n,Return()

exten => qwait,1,ExecIf($["${SAVEDCIDNAME}" = ""]?Set(__SAVEDCIDNAME=${CALLERID(name)}))
exten => qwait,n,Set(ELAPSED=${MATH($[${EPOCH}+30-${QUEUEWAIT}]/60,int)})
exten => qwait,n,Set(CALLERID(name)=M${ELAPSED}:${SAVEDCIDNAME})
exten => qwait,n,Return()

exten => ctset,1,Set(DB(CALLTRACE/${DEXTEN})=${CALLERID(number)})
exten => ctset,n,Return()

exten => ctclear,1,Noop(Deleting: CALLTRACE/${DEXTEN} ${DB_DELETE(CALLTRACE/${DEXTEN})})
exten => ctclear,n,Return()

exten => dstring,1,Set(DSTRING=)
exten => dstring,n,Set(DEVICES=${DB(AMPUSER/${DEXTEN}/device)})
exten => dstring,n,ExecIf($["${DEVICES}"=""]?Return())
exten => dstring,n,ExecIf($["${DEVICES:0:1}"="&"]?Set(DEVICES=${DEVICES:1}))
exten => dstring,n,Set(LOOPCNT=${FIELDQTY(DEVICES,&)})
exten => dstring,n,Set(ITER=1)
exten => dstring,n(begin),Set(THISDIAL=${DB(DEVICE/${CUT(DEVICES,&,${ITER})}/dial)})
exten => dstring,n,GosubIf($["${ASTCHANDAHDI}" = "1"]?zap2dahdi,1())
exten => dstring,n,Set(DSTRING=${DSTRING}${THISDIAL}&)
exten => dstring,n,Set(ITER=$[${ITER}+1])
exten => dstring,n,GotoIf($[${ITER}<=${LOOPCNT}]?begin)
exten => dstring,n,Set(DSTRING=${DSTRING:0:$[${LEN(${DSTRING})}-1]})
exten => dstring,n,Return()

exten => dlocal,1,Set(DSTRING=${IF($["${ARG1}"=""]?${DEXTEN:0:${MATH(${LEN(${DEXTEN})}-1,int)}}:Local/${DEXTEN:0:${MATH(${LEN(${DEXTEN})}-1,int)}}@from-internal/n)})
exten => dlocal,n,Set(USEGOTO=${IF($["${ARG1}"=""]?1:0)})
exten => dlocal,n,Return()

exten => zap2dahdi,1,ExecIf($["${THISDIAL}" = ""]?Return())
exten => zap2dahdi,n,Set(NEWDIAL=)
exten => zap2dahdi,n,Set(LOOPCNT2=${FIELDQTY(THISDIAL,&)})
exten => zap2dahdi,n,Set(ITER2=1)
exten => zap2dahdi,n(begin2),Set(THISPART2=${CUT(THISDIAL,&,${ITER2})})
exten => zap2dahdi,n,ExecIf($["${THISPART2:0:3}" = "ZAP"]?Set(THISPART2=DAHDI${THISPART2:3}))
exten => zap2dahdi,n,Set(NEWDIAL=${NEWDIAL}${THISPART2}&)
exten => zap2dahdi,n,Set(ITER2=$[${ITER2} + 1])
exten => zap2dahdi,n,GotoIf($[${ITER2} <= ${LOOPCNT2}]?begin2)
exten => zap2dahdi,n,Set(THISDIAL=${NEWDIAL:0:$[${LEN(${NEWDIAL})}-1]})
exten => zap2dahdi,n,Return()

exten => s-TORTURE,1,Goto(app-blackhole,musiconhold,1)
exten => s-TORTURE,n,Macro(hangupcall,)

exten => s-DONTCALL,1,Answer
exten => s-DONTCALL,n,Wait(1)
exten => s-DONTCALL,n,Zapateller()
exten => s-DONTCALL,n,Playback(ss-noservice)
exten => s-DONTCALL,n,Macro(hangupcall,)

exten => s-ANSWER,1,Return()
exten => s-ANSWER,n,Return()

exten => s-BUSY,1,Return()
exten => s-BUSY,n,Return()

exten => s-NOANSWER,1,Return()
exten => s-NOANSWER,n,Return()

exten => s-CHANUNAVAIL,1,Return()
exten => s-CHANUNAVAIL,n,Return()

[macro-dial-one-custom]
exten => s,1,Noop(CallMe macro-dial-one hook for ${ARG1})
; Для multi-звонков используем исходный linkedid, который уже установлен в macro-dial-one
; Если не установлен, пытаемся найти через CallMeLINKEDID или GLOBAL переменные
; ИСПРАВЛЕНИЕ: Используем проверку имени канала "from-queue" и QAGENT вместо CALLME_ROUTE_TYPE
; Шаг 1: Если CALLME_LINKEDID уже установлен, используем его
exten => s,n,GotoIf($["${CALLME_LINKEDID}"!=""]?linkedid_ok)
; Шаг 2: Пытаемся найти через CallMeLINKEDID
exten => s,n,GotoIf($["${CallMeLINKEDID}"!=""]?use_callme_linkedid)
; Шаг 3: Для multi-звонков (очереди) пытаемся найти через GLOBAL переменные
exten => s,n,Set(__CALLME_IS_MULTI=${IF($["${QAGENT}"!=""]?1:${IF($[${REGEX("from-queue" ${CHANNEL(name)})}]?1:0)})})
exten => s,n,GotoIf($["${CALLME_IS_MULTI}"="1"]?try_global_linkedid)
; Шаг 4: Fallback - используем текущий linkedid канала
exten => s,n,Set(__CALLME_LINKEDID=${CHANNEL(linkedid)})
exten => s,n,Goto(linkedid_ok)
exten => s,n(try_global_linkedid),Set(__CALLME_CID_KEY=${FILTER(0-9,${CALLERID(number)})})
exten => s,n,Set(__CALLME_LINKEDID=${IF($["${GLOBAL(ORIGINAL_LINKEDID_BY_CID_${CALLME_CID_KEY})}"!=""]?${GLOBAL(ORIGINAL_LINKEDID_BY_CID_${CALLME_CID_KEY})}:${CHANNEL(linkedid)})})
exten => s,n,Goto(linkedid_ok)
exten => s,n(use_callme_linkedid),Set(__CALLME_LINKEDID=${CallMeLINKEDID})
exten => s,n(linkedid_ok),Noop(CallMe resolved linkedid: ${CALLME_LINKEDID})
; Для multi-звонков сохраняем исходный linkedid в GLOBAL переменные (если еще не сохранен)
; Это нужно для того, чтобы другие каналы Local/ из очереди могли найти исходный linkedid
; ИСПРАВЛЕНИЕ: Используем проверку имени канала "from-queue" вместо CALLME_ROUTE_TYPE
exten => s,n,ExecIf($["${CALLME_CID_KEY}"=""]?Set(__CALLME_CID_KEY=${FILTER(0-9,${CALLERID(number)})}))
exten => s,n,ExecIf($[("${QAGENT}"!="" | ${REGEX("from-queue" ${CHANNEL(name)})}) & "${CALLME_LINKEDID}"!="${CHANNEL(linkedid)}"]?Set(GLOBAL(ORIGINAL_LINKEDID_BY_CID_${CALLME_CID_KEY})=${CALLME_LINKEDID}))
exten => s,n,Set(__CALLME_CALL_ID=${CALLME_CALL_ID})
exten => s,n,Set(__CALLME_DIRECTION=${IF($["${CALLME_DIRECTION}"=""]?inbound:${CALLME_DIRECTION})})
exten => s,n,Set(__CALLME_TARGET=${IF($[${LEN(${ARG1})}]?${ARG1}:${DEXTEN})})
exten => s,n,Set(__CALLME_AG_UNIQ=${IF($["${CALLME_AG_UNIQ}"=""]?${UNIQUEID}:${CALLME_AG_UNIQ})})
; Устанавливаем CALLME_ROUTE_TYPE с fallback, если он еще не установлен
; ИСПРАВЛЕНИЕ: Разбиваем сложную вложенную IF на простые проверки для Asterisk 1.8.13
exten => s,n,GotoIf($["${CALLME_ROUTE_TYPE}"!=""]?route_type_ok)
exten => s,n,GotoIf($["${QAGENT}"!=""]?set_multi)
exten => s,n,Set(__CALLME_CHAN_NAME=${CHANNEL(name)})
exten => s,n,Set(__CALLME_HAS_QUEUE=${REGEX("from-queue" ${CALLME_CHAN_NAME})})
exten => s,n,GotoIf($["${CALLME_HAS_QUEUE}"="1"]?set_multi)
exten => s,n,Set(__CALLME_ROUTE_TYPE=direct)
exten => s,n,Goto(route_type_ok)
exten => s,n(set_multi),Set(__CALLME_ROUTE_TYPE=multi)
exten => s,n(route_type_ok),Noop(CallMe route type: ${CALLME_ROUTE_TYPE})
exten => s,n,UserEvent(CallMeRingingStart,Linkedid: ${CALLME_LINKEDID},Target: ${CALLME_TARGET},AgentUniqueid: ${CALLME_AG_UNIQ},Direction: ${CALLME_DIRECTION},CallId: ${CALLME_CALL_ID},RouteType: ${CALLME_ROUTE_TYPE})
exten => s,n,Set(__CALLME_RING_SENT=1)
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${CALLME_INGRESS_CHANNEL})}]?${CALLME_INGRESS_CHANNEL}:${CHANNEL(name)})})
exten => s,n,ExecIf($[${LEN(${CALLME_CONNECTEDLINE_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CONNECTEDLINE_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
exten => s,n,Noop(CallMe connected line hook input name='${CALLME_CONNECTEDLINE_NAME}' source='${CALLME_CL_SOURCE}')
exten => s,n,ExecIf($[${LEN(${CALLME_CONNECTEDLINE_NAME})}]?Set(CONNECTEDLINE(name,i)=${CALLME_CONNECTEDLINE_NAME}))
exten => s,n,ExecIf($[${LEN(${CALLME_CONNECTEDLINE_NAME})}]?Set(CHANNEL(update_connected_line)=yes))
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}b(sub-callme-connectedline^s^1(${CALLME_CONNECTEDLINE_NAME},${CALLME_CL_SOURCE})))
; КРИТИЧНО: Для очередей (multi) устанавливаем CALLME_CARD_STATE=SHOW ДО Dial через опцию b
; Это необходимо, т.к. UserEvent не передаются через AMI для очередей в Asterisk 1.8
exten => s,n,ExecIf($["${CALLME_ROUTE_TYPE}"="multi"]?Set(D_OPTIONS=${D_OPTIONS}b(sub-callme-ringing-start^s^1^${CALLME_TARGET})))
; Для всех звонков (direct и multi) устанавливаем CALLME_CARD_STATE при ANSWER через опцию U
exten => s,n,Set(D_OPTIONS=${D_OPTIONS}gU(sub-callme-state^s^1^${CALLME_TARGET}))
exten => s,n,Return()

[sub-callme-ringing-start]
; КРИТИЧНО: Этот Gosub вызывается ДО Dial (опция b) для очередей (multi)
; Устанавливает CALLME_CARD_STATE=SHOW при начале дозвона (RINGING)
; Это необходимо, т.к. UserEvent не передаются через AMI для очередей в Asterisk 1.8
exten => s,1,Noop(CallMe ringing start hook for queue call on ${CHANNEL(name)})
; Определяем внутренний номер из ARG1 (CALLME_TARGET) или из канала
exten => s,n,Set(CALLME_EXT_RAW=${IF($[${LEN(${ARG1})}]?${ARG1}:${CUT(CHANNEL(name),/,2)})})
exten => s,n,GotoIf($["${CALLME_EXT_RAW}"=""]?skip_primary_trim)
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)})
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,\;,1)})
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)})
exten => s,n(skip_primary_trim),Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})})
exten => s,n,Set(CALLME_EXT_LEN=${LEN(${CALLME_EXT_RAW})})
exten => s,n,GotoIf($[${CALLME_EXT_LEN}>=2 & ${CALLME_EXT_LEN}<=6]?resolved)
; Fallback: пытаемся определить из DEXTEN или других источников
exten => s,n,Set(CALLME_EXT_RAW=${IF($[${LEN(${DEXTEN})}]?${DEXTEN}:${CALLME_EXT_RAW})})
exten => s,n,Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})})
exten => s,n,Set(CALLME_EXT_LEN=${LEN(${CALLME_EXT_RAW})})
exten => s,n,GotoIf($[${CALLME_EXT_LEN}>=2 & ${CALLME_EXT_LEN}<=6]?resolved:noagent)
exten => s,n(resolved),Noop(CallMe ringing start resolved extension ${CALLME_EXT_RAW})
; Убеждаемся, что CALLME_LINKEDID установлен (должен быть установлен в macro-dial-one-custom)
exten => s,n,ExecIf($[${LEN(${CALLME_LINKEDID})}=0]?Set(CALLME_LINKEDID=${IF($["${CallMeLINKEDID}"!=""]?${CallMeLINKEDID}:${CHANNEL(linkedid)})}))
; Убеждаемся, что CALLME_ROUTE_TYPE установлен (должен быть multi для очередей)
exten => s,n,ExecIf($["${CALLME_ROUTE_TYPE}"=""]?Set(CALLME_ROUTE_TYPE=multi))
; Убеждаемся, что CALLME_CALL_ID установлен
exten => s,n,ExecIf($[${LEN(${CALLME_CALL_ID})}=0]?Noop(CallMe ringing start: CALLME_CALL_ID not set yet))
; КРИТИЧНО: Устанавливаем CALLME_CARD_STATE=SHOW ДО Dial для очередей
; Формат: SHOW|linkedid|intNum|callId|routeType
exten => s,n,Set(CALLME_CARD_STATE=SHOW|${IF($[${LEN(${CALLME_LINKEDID})}]?${CALLME_LINKEDID}:${CHANNEL(linkedid)})}|${CALLME_EXT_RAW}|${CALLME_CALL_ID}|${IF($[${LEN(${CALLME_ROUTE_TYPE})}]?${CALLME_ROUTE_TYPE}:multi)})
exten => s,n,Noop(CallMe ringing start: CALLME_CARD_STATE=SHOW set for ${CALLME_EXT_RAW}, linkedid=${CALLME_LINKEDID}, callId=${CALLME_CALL_ID})
exten => s,n(return),Return()
exten => s,n(noagent),Noop(CallMe ringing start: unable to resolve extension, skipping CALLME_CARD_STATE)
exten => s,n,Goto(return)

[sub-callme-hangup]
exten => s,1,Noop(CallMe hangup handler for ${ARG1} status=${DIALSTATUS})
exten => s,n,ExecIf($["${CALLME_RING_SENT}"="1"]?UserEvent(CallMeRingingStop,Linkedid: ${CALLME_LINKEDID},Target: ${IF($[${LEN(${ARG1})}]?${ARG1}:${CALLME_TARGET})},AgentUniqueid: ${CALLME_AG_UNIQ},Direction: ${CALLME_DIRECTION},DialStatus: ${DIALSTATUS},CallId: ${CALLME_CALL_ID},RouteType: ${CALLME_ROUTE_TYPE}))
exten => s,n,Return()

[sub-callme-state]
exten => s,1,Noop(CallMe state hook on ${CHANNEL(name)})
exten => s,n,Set(CALLME_EXT_RAW=${IF($["${CALLME_TARGET}"!=""]?${CALLME_TARGET}:${CUT(CHANNEL(name),/,2)})})
exten => s,n,GotoIf($["${CALLME_EXT_RAW}"=""]?skip_primary_trim)
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)})
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,\;,1)})
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)})
exten => s,n(skip_primary_trim),Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})})
exten => s,n,Set(CALLME_EXT_LEN=${LEN(${CALLME_EXT_RAW})})
exten => s,n,GotoIf($[${CALLME_EXT_LEN}>=2 & ${CALLME_EXT_LEN}<=6]?resolved)
exten => s,n,Set(CALLME_EXT_RAW=${CONNECTEDLINE(num)})
exten => s,n,GotoIf($["${CALLME_EXT_RAW}"=""]?noagent)
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,@,1)})
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,\;,1)})
exten => s,n,Set(CALLME_EXT_RAW=${CUT(CALLME_EXT_RAW,-,1)})
exten => s,n,Set(CALLME_EXT_RAW=${FILTER(0-9,${CALLME_EXT_RAW})})
exten => s,n,Set(CALLME_EXT_LEN=${LEN(${CALLME_EXT_RAW})})
exten => s,n,GotoIf($[${CALLME_EXT_LEN}>=2 & ${CALLME_EXT_LEN}<=6]?resolved:noagent)
exten => s,n(resolved),Noop(CallMe resolved extension ${CALLME_EXT_RAW})
exten => s,n,Set(__CALLME_AGENT=${CALLME_EXT_RAW})
exten => s,n,ExecIf($["${CALLME_DIRECTION}"=""]?Set(__CALLME_DIRECTION=inbound))
; Для multi-звонков пытаемся найти исходный linkedid через GLOBAL переменные
exten => s,n,ExecIf($[${LEN(${CALLME_LINKEDID})}=0]?Set(CALLME_LINKEDID=${IF($["${CALLME_ROUTE_TYPE}"="multi"]?${IF($["${GLOBAL(ORIGINAL_LINKEDID_BY_CID_${FILTER(0-9,${CALLERID(number)})})}"!=""]?${GLOBAL(ORIGINAL_LINKEDID_BY_CID_${FILTER(0-9,${CALLERID(number)})})}:${CHANNEL(linkedid)}):${CHANNEL(linkedid)})}))
exten => s,n,ExecIf($[${LEN(${CALLME_AG_UNIQ})}=0]?Set(CALLME_AG_UNIQ=${UNIQUEID}))
exten => s,n,UserEvent(CallMeRingingAnswer,Linkedid: ${CALLME_LINKEDID},Target: ${CALLME_AGENT},AgentUniqueid: ${CALLME_AG_UNIQ},Direction: ${CALLME_DIRECTION},CallId: ${CALLME_CALL_ID},RouteType: ${CALLME_ROUTE_TYPE})
exten => s,n,Set(CALLME_CARD_STATE=SHOW|${IF($[${LEN(${CALLME_LINKEDID})}]?${CALLME_LINKEDID}:${CHANNEL(linkedid)})}|${CALLME_EXT_RAW}|${CALLME_CALL_ID}|${IF($[${LEN(${CALLME_ROUTE_TYPE})}]?${CALLME_ROUTE_TYPE}:direct)})
exten => s,n(return),Return()
exten => s,n(noagent),Noop(CallMe state hook exit without resolved agent on ${CHANNEL(name)})
exten => s,n,Goto(return)

[hangup-callme-operator]
exten => s,1,ExecIf($[${LEN(${ARG1})}=0]?Return())
exten => s,n,Set(CALLME_CARD_STATE=HIDE|${IF($[${LEN(${CALLME_LINKEDID})}]?${CALLME_LINKEDID}:${CHANNEL(linkedid)})}|${ARG1}|${CALLME_CALL_ID}|${IF($[${LEN(${CALLME_ROUTE_TYPE})}]?${CALLME_ROUTE_TYPE}:direct)})
exten => s,n,Return()

[sub-callme-connectedline]
exten => s,1,Noop(CallMe connected line update on ${CHANNEL(name)})
exten => s,n,Set(CALLME_CL_NAME=${IF($[${LEN(${ARG1})}]?${ARG1}:${CALLME_CONNECTEDLINE_NAME})})
exten => s,n,Set(CALLME_CL_SOURCE=${IF($[${LEN(${ARG2})}]?${ARG2}:${CALLME_INGRESS_CHANNEL})})
exten => s,n,ExecIf($[${LEN(${CALLME_CL_NAME})}=0 & ${LEN(${CALLME_CL_SOURCE})}]?Set(CALLME_CL_NAME=${SHARED(CALLME_CL_NAME,${CALLME_CL_SOURCE})}))
exten => s,n,Noop(CallMe connected line resolved name: ${CALLME_CL_NAME} (source=${CALLME_CL_SOURCE}))
exten => s,n,ExecIf($[${LEN(${CALLME_CL_NAME})}=0]?Return())
exten => s,n,Set(CALLERID(name)=${CALLME_CL_NAME})
exten => s,n,Set(CONNECTEDLINE(name,i)=${CALLME_CL_NAME})
exten => s,n,Set(CONNECTEDLINE(name-pres)=allowed_not_screened)
exten => s,n,Set(CHANNEL(update_connected_line)=yes)
exten => s,n,UserEvent(CallMeConnectedLineUpdate,Linkedid: ${CHANNEL(linkedid)},TargetChannel: ${CHANNEL(name)},Name: ${CALLME_CL_NAME})
exten => s,n,Return()
